<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>GraphQL API | Magek Framework</title><meta name="description" content="Documentation for Magek Framework"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><link rel="stylesheet" href="../assets/custom.css"/><script defer src="../assets/main.js"></script><script defer src="../assets/custom.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">Magek Framework</a><div id="tsd-toolbar-links"><a href="https://github.com/theam/magek">GitHub</a></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="Documentation.html">Documentation</a></li><li><a href="" aria-current="page">GraphQL API</a></li></ul></div><div class="tsd-panel tsd-typography"><h1 id="graphql-api" class="tsd-anchor-link">GraphQL API<a href="#graphql-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This is the main API of your application, as it allows you to:</p>
<ul>
<li><em>Modify</em> data by <strong>sending commands</strong>.</li>
<li><em>Read</em> data by <strong>querying read models</strong>.</li>
<li><em>Receive data in real time</em> by <strong>subscribing to read models</strong>.</li>
</ul>
<p>All this is done through <a href="https://graphql.org/">GraphQL</a>, a query language for APIs that has useful advantages over simple REST APIs.</p>
<p>If you are not familiar with GraphQL, then, first of all, don't worry!
<em>Using</em> a GraphQL API is simple and straightforward.
<em>Implementing it</em> on the server side is usually the hard part, as you need to define your schema, operations, resolvers, etc.
Luckily, you can forget about that because Magek does all the work for you!</p>
<p>The GraphQL API is fully <strong>auto-generated</strong> based on your <em>commands</em> and <em>read models</em>.</p>
<blockquote>
<p><strong>Note:</strong>
To get the full potential of the GraphQL API,  it is <strong>not</strong> recommended to use <code>interface</code> types in any command or read model attributes. Use <code>class</code> types instead. This will allow you to perform complex graphQL filters, including over nested attributes. There's an example below:</p>
</blockquote>
<pre><code class="typescript"><span class="hl-5">// My type</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">ItemWithQuantity</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">// Use &quot;class&quot;, not &quot;interface&quot;</span><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-4">sku</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-4">quantity</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<pre><code class="typescript"><span class="hl-5">// The read-model file</span><br/><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CartReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-4">item</span><span class="hl-1">!: </span><span class="hl-7">ItemWithQuantity</span><span class="hl-1"> </span><span class="hl-5">// As ItemWithQuantity is a class, you will be able to query over nested attributes like item `quantity`</span>
</code><button type="button">Copy</button></pre>

<h2 id="relationship-between-graphql-operations-and-commands-and-read-models" class="tsd-anchor-link">Relationship between GraphQL operations and commands and read models<a href="#relationship-between-graphql-operations-and-commands-and-read-models" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>GraphQL defines three kinds of operations that you can use: <em>mutations</em>, <em>queries</em>, and <em>subscriptions</em>.</p>
<p>The names are pretty meaningful, but we can say that you use a <code>mutation</code> when you want to change data, a <code>query</code> when you want to get
data on-demand, and a <code>subscription</code> when you want to receive data at the moment it is updated.</p>
<p>Knowing this, you can infer the relationship between those operations and your Magek components:</p>
<ul>
<li>You <em>send</em> a <strong>command</strong> using a <strong>mutation</strong>.</li>
<li>You <em>read</em> a <strong>read model</strong> using a <strong>query</strong>.</li>
<li>You <em>subscribe</em> to a <strong>read model</strong> using a <strong>subscription</strong>.</li>
</ul>
<h2 id="how-to-send-graphql-request" class="tsd-anchor-link">How to send GraphQL request<a href="#how-to-send-graphql-request" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>GraphQL uses two existing protocols:</p>
<ul>
<li><em>HTTP</em> for <code>mutation</code> and <code>query</code> operations.</li>
<li><em>WebSocket</em> for <code>subscription</code> operations.</li>
</ul>
<p>The reason for the WebSocket protocol is that, in order for subscriptions to work, there must be a way for the server to send data to clients when it is changed. HTTP doesn't allow that, as it is the client the one which always initiates the request.</p>
<p>So you should use the <strong>graphqlURL</strong> to send GraphQL queries and mutations, and the <strong>websocketURL</strong> to send subscriptions. You can see both URLs when starting your application.</p>
<p>Therefore:</p>
<ul>
<li>To send a GraphQL mutation/query, you send an HTTP request to <em>&quot;&lt;graphqlURL&gt;&quot;</em>, with <em>method POST</em>, and a <em>JSON-encoded body</em> with the mutation/query details.</li>
<li>To send a GraphQL subscription, you first connect to the <em>&quot;&lt;websocketURL&gt;&quot;</em>, and then send a <em>JSON-encoded message</em> with the subscription details, <em>following <a href="#the-graphql-over-websocket-protocol">the &quot;GraphQL over WebSocket&quot; protocol</a></em>.</li>
</ul>
<blockquote>
<p><strong>Note:</strong>
You can also <strong>send queries and mutations through the WebSocket</strong> if that's convenient to you. See <a href="#the-graphql-over-websocket-protocol">&quot;The GraphQL over WebSocket protocol&quot;</a> to know more.</p>
</blockquote>
<p>While it is OK to know how to manually send GraphQL request, you normally don't need to deal with this low-level details, especially with the WebSocket stuff.</p>
<p>To have a great developer experience, we <strong>strongly recommend</strong> to use a GraphQL client for your platform of choice. Here are some great ones:</p>
<ul>
<li><strong><a href="https://altair.sirmuel.design/">Altair</a></strong>: Ideal for testing sending manual requests, getting the schema, etc.</li>
<li><strong>Apollo clients</strong>: These are the &quot;go-to&quot; SDKs to interact with a GraphQL API from your clients. It is very likely that there is a version for your client programming language. Check the <a href="#using-apollo-client">&quot;Using Apollo Client&quot;</a> section to know more about this.</li>
</ul>
<h2 id="get-graphql-schema-from-your-application" class="tsd-anchor-link">Get GraphQL schema from your application<a href="#get-graphql-schema-from-your-application" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>After starting your application, you can get your GraphQL schema by using a tool like <strong><a href="https://altair.sirmuel.design/">Altair</a></strong>. The graphqlURL endpoint has the following pattern:</p>
<p><code>https://&lt;base_url&gt;/&lt;environment&gt;/graphql</code></p>
<p>By entering this URL in Altair, the schema can be displayed as shown in the screenshot (You need to click on the Docs button in the URL bar). You can
check the available Queries and Mutations by clicking on their name:</p>
<p><img src="/img/altair-queries.png" alt="Altair queries">
<img src="/img/altair-mutations.png" alt="Altair mutations"></p>
<h2 id="sending-commands" class="tsd-anchor-link">Sending commands<a href="#sending-commands" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>As mentioned in the previous section, we need to use a &quot;mutation&quot; to send a command. The structure of a mutation (the body of the request) is the following:</p>
<pre><code class="graphql"><span class="hl-3">mutation</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">command_name</span><span class="hl-1">(</span><span class="hl-4">input</span><span class="hl-1">: {</span><br/><span class="hl-3">    input_field_list</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Where:</p>
<ul>
<li><em><strong>command_name</strong></em> is the name of the class corresponding to the command you want to send</li>
<li><em><strong>input_field_list</strong></em> is a list of pairs in the form of <code>fieldName: fieldValue</code> containing the data of your command. The field names correspond to the names of the properties you defined in the command class.</li>
</ul>
<p>In the following example we send a command named &quot;ChangeCart&quot; that will add/remove an item to/from a shopping cart. The command requires the ID of the cart (<code>cartId</code>), the item identifier (<code>sku</code>) and the quantity of units we are adding/removing (<code>quantity</code>).</p>
<pre><code class="text">URL: &quot;&lt;graphqlURL&gt;&quot;
</code><button type="button">Copy</button></pre>

<pre><code class="graphql"><span class="hl-3">mutation</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">ChangeCart</span><span class="hl-1">(</span><span class="hl-4">input</span><span class="hl-1">: { </span><span class="hl-2">cartId</span><span class="hl-1">: </span><span class="hl-2">&quot;demo&quot;</span><span class="hl-1">, </span><span class="hl-2">sku</span><span class="hl-1">: </span><span class="hl-2">&quot;ABC_01&quot;</span><span class="hl-1">, </span><span class="hl-2">quantity</span><span class="hl-1">: </span><span class="hl-9">2</span><span class="hl-1"> })</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>In case we are not using any GraphQL client, this would be the equivalent bare HTTP request:</p>
<pre><code class="text">URL: &quot;&lt;graphqlURL&gt;&quot;
METHOD: &quot;POST&quot;
</code><button type="button">Copy</button></pre>

<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;query&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;mutation { ChangeCart(input: { cartId: </span><span class="hl-13">\&quot;</span><span class="hl-2">demo</span><span class="hl-13">\&quot;</span><span class="hl-2"> sku: </span><span class="hl-13">\&quot;</span><span class="hl-2">ABC_01</span><span class="hl-13">\&quot;</span><span class="hl-2"> quantity: 2 }) }&quot;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>And this would be the response:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;data&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-10">&quot;ChangeCart&quot;</span><span class="hl-1">: </span><span class="hl-3">true</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Note:</strong>
Remember to set the proper <strong>access token</strong> for secured commands, check <a href="#authorizing-operations">&quot;Authorizing operations&quot;</a>.</p>
</blockquote>
<h2 id="reading-read-models" class="tsd-anchor-link">Reading read models<a href="#reading-read-models" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>To read a specific read model, we need to use a &quot;query&quot; operation. The structure of the &quot;query&quot; (the body
of the request) is the following:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">read_model_name</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-2">&quot;&lt;id of the read model&gt;&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">selection_field_list</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Where:</p>
<ul>
<li><em>read_model_name</em> is the name of the class corresponding to the read model you want to retrieve.</li>
<li><em>&lt;id of the read model&gt;</em> is the ID of the specific read model instance you are interested in.</li>
<li><em>selection_field_list</em> is a list with the names of the specific read model fields you want to get as response.</li>
</ul>
<p>In the following example we send a query to read a read model named <code>CartReadModel</code> whose ID is <code>demo</code>. We get back its <code>id</code> and the list of cart <code>items</code> as response.</p>
<pre><code class="text">URL: &quot;&lt;graphqlURL&gt;&quot;
</code><button type="button">Copy</button></pre>

<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">CartReadModel</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-2">&quot;demo&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><br/><span class="hl-1">    </span><span class="hl-4">items</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>In case we are not using any GraphQL client, this would be the equivalent bare HTTP request:</p>
<pre><code class="text">URL: &quot;&lt;graphqlURL&gt;&quot;
METHOD: &quot;POST&quot;
</code><button type="button">Copy</button></pre>

<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;query&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;query { CartReadModel(id: </span><span class="hl-13">\&quot;</span><span class="hl-2">demo</span><span class="hl-13">\&quot;</span><span class="hl-2">) { id items } }&quot;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>And we would get the following as response:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;data&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-10">&quot;CartReadModel&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">      </span><span class="hl-10">&quot;id&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;demo&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-10">&quot;items&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">        {</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;sku&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;ABC_01&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;quantity&quot;</span><span class="hl-1">: </span><span class="hl-9">2</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">      ]</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Note:</strong>
Remember to set the proper <strong>access token</strong> for secured read models, check <a href="#authorizing-operations">&quot;Authorizing operations&quot;</a>.</p>
</blockquote>
<h2 id="subscribing-to-read-models" class="tsd-anchor-link">Subscribing to read models<a href="#subscribing-to-read-models" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>To subscribe to a specific read model, we need to use a subscription operation, and it must be <em>sent through the <strong>websocketURL</strong></em> using the <a href="#the-graphql-over-websocket-protocol"><em>GraphQL over WebSocket</em> protocol</a>.</p>
<p>Doing this process manually is a bit cumbersome. <em>You will probably never need to do this</em>, as GraphQL clients like <a href="#using-apollo-client">Apollo</a> abstract this process away. However, we will explain how to do it for learning purposes.</p>
<p>Before sending any subscription, you need to <em>connect</em> to the WebSocket to open the two-way communication channel. This connection is done differently depending on the client/library you use to manage web sockets. In this section, we will show examples using the <a href="https://github.com/websockets/wscat"><code>wscat</code></a> command line program. You can also use the online tool <a href="https://altair.sirmuel.design/">Altair</a></p>
<p>Once you have connected successfully, you can use this channel to:</p>
<ul>
<li>Send the subscription messages.</li>
<li>Listen for messages sent by the server with data corresponding to your active subscriptions.</li>
</ul>
<p>The structure of the &quot;subscription&quot; (the body of the message) is exactly the same as the &quot;query&quot; operation:</p>
<pre><code class="graphql"><span class="hl-0">subscription</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">read_model_name</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-2">&quot;&lt;id of the read model&gt;&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">selection_field_list</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Where:</p>
<ul>
<li><em>read_model_name</em> is the name of the class corresponding to the read model you want to subscribe to.</li>
<li><em>&lt;id of the read model&gt;</em> is the ID of the specific read model instance you are interested in.</li>
<li><em>selection_field_list</em> is a list with the names of the specific read model fields you want to get when data is sent back to you.</li>
</ul>
<p>In the following examples we use <a href="https://github.com/websockets/wscat"><code>wscat</code></a> to connect to the web socket. After that, we send the required messages to conform the <a href="#the-graphql-over-websocket-protocol"><em>GraphQL over WebSocket</em> protocol</a>, including the subscription operation to the read model <code>CartReadModel</code> with ID <code>demo</code>.</p>
<ol>
<li>Connect to the web socket:</li>
</ol>
<pre><code class="sh"><span class="hl-1"> </span><span class="hl-0">wscat</span><span class="hl-1"> </span><span class="hl-3">-c</span><span class="hl-1"> &lt;</span><span class="hl-2">websocketUR</span><span class="hl-1">L&gt; </span><span class="hl-3">-s</span><span class="hl-1"> </span><span class="hl-2">graphql-ws</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Note:</strong>
You should specify the <code>graphql-ws</code> subprotocol when connecting with your client via the <code>Sec-WebSocket-Protocol</code> header (in this case, <code>wscat</code> does that when you use the <code>-s</code> option).</p>
</blockquote>
<p>Now we can start sending messages just by writing them and hitting the <kbd>Enter</kbd> key.</p>
<ol start="2">
<li>Initiate the protocol connection :</li>
</ol>
<pre><code class="json"><span class="hl-1">{ </span><span class="hl-10">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;connection_init&quot;</span><span class="hl-1"> }</span>
</code><button type="button">Copy</button></pre>

<p>In case you want to authorize the connection, you need to send the authorization token in the <code>payload.Authorization</code> field:</p>
<pre><code class="json"><span class="hl-1">{ </span><span class="hl-10">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;connection_init&quot;</span><span class="hl-1">, </span><span class="hl-10">&quot;payload&quot;</span><span class="hl-1">: { </span><span class="hl-10">&quot;Authorization&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;&lt;your token&gt;&quot;</span><span class="hl-1"> } }</span>
</code><button type="button">Copy</button></pre>

<ol start="3">
<li>Send a message with the subscription. We need to provide an ID for the operation. When the server sends us data back, it will include this same ID so that we know which subscription the received data belongs to (again, this is just for learning, <a href="#using-apollo-client">GraphQL clients</a> manages this for you)</li>
</ol>
<pre><code class="json"><span class="hl-1">{ </span><span class="hl-10">&quot;id&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;1&quot;</span><span class="hl-1">, </span><span class="hl-10">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;start&quot;</span><span class="hl-1">, </span><span class="hl-10">&quot;payload&quot;</span><span class="hl-1">: { </span><span class="hl-10">&quot;query&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;subscription { CartReadModel(id:</span><span class="hl-13">\&quot;</span><span class="hl-2">demo</span><span class="hl-13">\&quot;</span><span class="hl-2">) { id items } }&quot;</span><span class="hl-1"> } }</span>
</code><button type="button">Copy</button></pre>

<p>After a successful subscription, you won't receive anything in return. Now, every time the read model you subscribed to is modified, a new incoming message will appear in the socket with the updated version of the read model. This message will have exactly the same format as if you were done a query with the same parameters.</p>
<p>Following with the previous example, we now send a command (using a mutation operation) that adds a new item with sku &quot;ABC_02&quot; to the <code>CartReadModel</code>. After it has been added, we receive the updated version of the read model through the socket.</p>
<ol>
<li>Send the following command (this time using an HTTP request):</li>
</ol>
<pre><code><span class="hl-12">URL</span><span class="hl-1">: </span><span class="hl-2">&quot;&lt;graphqlURL&gt;&quot;</span>
</code><button>Copy</button></pre>

<pre><code class="graphql"><span class="hl-3">mutation</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">ChangeCart</span><span class="hl-1">(</span><span class="hl-4">input</span><span class="hl-1">: { </span><span class="hl-2">cartId</span><span class="hl-1">: </span><span class="hl-2">&quot;demo&quot;</span><span class="hl-1">, </span><span class="hl-2">sku</span><span class="hl-1">: </span><span class="hl-2">&quot;ABC_02&quot;</span><span class="hl-1">, </span><span class="hl-2">quantity</span><span class="hl-1">: </span><span class="hl-9">3</span><span class="hl-1"> })</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ol start="2">
<li>The following message (after formatting it) appears through the socket connection we had opened:</li>
</ol>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;id&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;data&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;payload&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-10">&quot;data&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">      </span><span class="hl-10">&quot;CartReadModel&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">        </span><span class="hl-10">&quot;id&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;demo&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-10">&quot;items&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">          {</span><br/><span class="hl-1">            </span><span class="hl-10">&quot;sku&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;ABC_01&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-10">&quot;quantity&quot;</span><span class="hl-1">: </span><span class="hl-9">2</span><br/><span class="hl-1">          },</span><br/><span class="hl-1">          {</span><br/><span class="hl-1">            </span><span class="hl-10">&quot;sku&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;ABC_02&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-10">&quot;quantity&quot;</span><span class="hl-1">: </span><span class="hl-9">3</span><br/><span class="hl-1">          }</span><br/><span class="hl-1">        ]</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Note:</strong>
Remember that, in case you want to subscribe to a read model that is restricted to a specific set of roles, you must send the <strong>access token</strong> retrieved upon sign-in. Check <a href="#authorizing-operations">&quot;Authorizing operations&quot;</a> to know how to do this.</p>
</blockquote>
<blockquote>
<p><strong>Note:</strong>
You can disable the creation of all the infrastructure and functionality needed to manage subscriptions by setting <code>config.enableSubscriptions=false</code> in your <code>Magek.config</code> block</p>
</blockquote>
<h2 id="non-exposing-properties-and-parameters" class="tsd-anchor-link">Non exposing properties and parameters<a href="#non-exposing-properties-and-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>By default, all properties and parameters of the command constructor and/or read model are accessible through GraphQL. It is possible to not expose any of them adding the <code>@nonExposed</code> annotation to the constructor property or parameter.</p>
<p>Example</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CartReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">cartItems</span><span class="hl-1">!: </span><span class="hl-7">Array</span><span class="hl-1">&lt;</span><span class="hl-7">CartItem</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">checks</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">shippingAddress</span><span class="hl-1">?: </span><span class="hl-7">Address</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">payment</span><span class="hl-1">?: </span><span class="hl-7">Payment</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">cartItemsIds</span><span class="hl-1">?: </span><span class="hl-7">Array</span><span class="hl-1">&lt;</span><span class="hl-7">string</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">  @</span><span class="hl-4">nonExposed</span><br/><span class="hl-1">  </span><span class="hl-3">private</span><span class="hl-1"> </span><span class="hl-4">internalProperty</span><span class="hl-1">?: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  @</span><span class="hl-4">nonExposed</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">internalParameter</span><span class="hl-1">?: </span><span class="hl-7">number</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="adding-before-hooks-to-your-read-models" class="tsd-anchor-link">Adding before hooks to your read models<a href="#adding-before-hooks-to-your-read-models" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>When you send queries or subscriptions to your read models, you can tell Magek to execute some code before executing the operation. These are called <code>before</code> hooks, and they receive a <code>ReadModelRequestEnvelope</code> object representing the current request.</p>
<pre><code class="typescript"><span class="hl-3">interface</span><span class="hl-1"> </span><span class="hl-7">ReadModelRequestEnvelope</span><span class="hl-1">&lt;</span><span class="hl-7">TReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  </span><span class="hl-4">currentUser</span><span class="hl-1">?: </span><span class="hl-7">UserEnvelope</span><span class="hl-1"> </span><span class="hl-5">// The current authenticated user</span><br/><span class="hl-1">  </span><span class="hl-4">requestID</span><span class="hl-1">: </span><span class="hl-7">UUID</span><span class="hl-1"> </span><span class="hl-5">// An ID assigned to this request</span><br/><span class="hl-1">  </span><span class="hl-4">key</span><span class="hl-1">?: { </span><span class="hl-5">// If present, contains the id and sequenceKey that identify a specific read model</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-7">UUID</span><br/><span class="hl-1">    </span><span class="hl-4">sequenceKey</span><span class="hl-1">?: </span><span class="hl-7">SequenceKey</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-4">className</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1"> </span><span class="hl-5">// The read model class name</span><br/><span class="hl-1">  </span><span class="hl-4">filters</span><span class="hl-1">: </span><span class="hl-7">ReadModelRequestProperties</span><span class="hl-1">&lt;</span><span class="hl-7">TReadModel</span><span class="hl-1">&gt; </span><span class="hl-5">// Filters set in the GraphQL query</span><br/><span class="hl-1">  </span><span class="hl-4">limit</span><span class="hl-1">?: </span><span class="hl-7">number</span><span class="hl-1"> </span><span class="hl-5">// Query limit if set</span><br/><span class="hl-1">  </span><span class="hl-4">afterCursor</span><span class="hl-1">?: </span><span class="hl-7">unknown</span><span class="hl-1"> </span><span class="hl-5">// For paginated requests, id to start reading from</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>In before hooks, you can either abort the request or alter and return the request object to change the behavior of your request. Before hooks are useful for many use cases, but they're especially useful to add fine-grained access control. For example, to enforce a filter that restrict a logged in user to access only read models objects they own.</p>
<p>When a <code>before</code> hook throws an exception, the request is aborted and the error is sent back to the user. In order to continue with the request, it's required that the request object is returned.</p>
<p>In order to define a before hook you pass a list of functions with the right signature to the read model decorator <code>before</code> parameter:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> [</span><span class="hl-4">User</span><span class="hl-1">],</span><br/><span class="hl-1">  </span><span class="hl-4">before:</span><span class="hl-1"> [</span><span class="hl-4">validateUser</span><span class="hl-1">],</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CartReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">userId</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  </span><span class="hl-5">// Your projections go here</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">validateUser</span><span class="hl-1">(</span><span class="hl-4">request</span><span class="hl-1">: </span><span class="hl-7">ReadModelRequestEnvelope</span><span class="hl-1">&lt;</span><span class="hl-7">CartReadModel</span><span class="hl-1">&gt;): </span><span class="hl-7">ReadModelRequestEnvelope</span><span class="hl-1">&lt;</span><span class="hl-7">CartReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-4">request</span><span class="hl-1">.</span><span class="hl-4">filters</span><span class="hl-1">?.</span><span class="hl-4">userId</span><span class="hl-1">?.</span><span class="hl-4">eq</span><span class="hl-1"> !== </span><span class="hl-4">request</span><span class="hl-1">.</span><span class="hl-4">currentUser</span><span class="hl-1">?.</span><span class="hl-4">id</span><span class="hl-1">) </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-0">NotAuthorizedError</span><span class="hl-1">(</span><span class="hl-2">&quot;...&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">request</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>You can also define more than one <code>before</code> hook for a read model, and they will be chained, sending the resulting request object from a hook to the next one.</p>
<blockquote>
<p><strong>Note:</strong>
The order in which filters are specified matters.</p>
</blockquote>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> [</span><span class="hl-4">User</span><span class="hl-1">],</span><br/><span class="hl-1">  </span><span class="hl-4">before:</span><span class="hl-1"> [</span><span class="hl-4">validateUser</span><span class="hl-1">, </span><span class="hl-4">validateEmail</span><span class="hl-1">, </span><span class="hl-4">changeFilters</span><span class="hl-1">],</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CartReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">userId</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  </span><span class="hl-5">// Your projections go here</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">validateUser</span><span class="hl-1">(</span><span class="hl-4">request</span><span class="hl-1">: </span><span class="hl-7">ReadModelRequestEnvelope</span><span class="hl-1">&lt;</span><span class="hl-7">CartReadModel</span><span class="hl-1">&gt;): </span><span class="hl-7">ReadModelRequestEnvelope</span><span class="hl-1">&lt;</span><span class="hl-7">CartReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-4">request</span><span class="hl-1">.</span><span class="hl-4">filters</span><span class="hl-1">?.</span><span class="hl-4">userId</span><span class="hl-1">?.</span><span class="hl-4">eq</span><span class="hl-1"> !== </span><span class="hl-4">request</span><span class="hl-1">.</span><span class="hl-4">currentUser</span><span class="hl-1">?.</span><span class="hl-4">id</span><span class="hl-1">) </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-0">NotAuthorizedError</span><span class="hl-1">(</span><span class="hl-2">&quot;...&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">request</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">validateEmail</span><span class="hl-1">(</span><span class="hl-4">request</span><span class="hl-1">: </span><span class="hl-7">ReadModelRequestEnvelope</span><span class="hl-1">&lt;</span><span class="hl-7">CartReadModel</span><span class="hl-1">&gt;): </span><span class="hl-7">ReadModelRequestEnvelope</span><span class="hl-1">&lt;</span><span class="hl-7">CartReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-4">request</span><span class="hl-1">.</span><span class="hl-4">filters</span><span class="hl-1">.</span><span class="hl-4">email</span><span class="hl-1">.</span><span class="hl-0">includes</span><span class="hl-1">(</span><span class="hl-2">&#39;myCompanyDomain.com&#39;</span><span class="hl-1">)) </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-0">NotAuthorizedError</span><span class="hl-1">(</span><span class="hl-2">&quot;...&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">request</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="adding-before-hooks-to-your-commands" class="tsd-anchor-link">Adding before hooks to your commands<a href="#adding-before-hooks-to-your-commands" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>You can use <code>before</code> hooks also in your command handlers, and <a href="#Adding-before-hooks-to-your-read-models">they work as the Read Models ones</a>, with a slight difference: <strong>we don't modify <code>filters</code> but <code>inputs</code> (the parameters sent with a command)</strong>. Apart from that, it's pretty much the same, here's an example:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> [</span><span class="hl-4">User</span><span class="hl-1">],</span><br/><span class="hl-1">  </span><span class="hl-4">before:</span><span class="hl-1"> [</span><span class="hl-4">beforeFn</span><span class="hl-1">],</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">ChangeCartItem</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">cartId</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">productId</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">beforeFn</span><span class="hl-1">(</span><span class="hl-4">input</span><span class="hl-1">: </span><span class="hl-7">CommandInput</span><span class="hl-1">, </span><span class="hl-4">currentUser</span><span class="hl-1">?: </span><span class="hl-7">UserEnvelope</span><span class="hl-1">): </span><span class="hl-7">CommandInput</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-4">input</span><span class="hl-1">.</span><span class="hl-4">cartUserId</span><span class="hl-1"> !== </span><span class="hl-4">currentUser</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-0">NonAuthorizedUserException</span><span class="hl-1">() </span><span class="hl-5">// We don&#39;t let this user to trigger the command</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">input</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>As you can see, we just check if the <code>cartUserId</code> is equal to the <code>currentUser.id</code>, which is the user id extracted from the auth token. This way, we can throw an exception and avoid this user to call this command.</p>
<h2 id="adding-before-hooks-to-your-queries" class="tsd-anchor-link">Adding before hooks to your queries<a href="#adding-before-hooks-to-your-queries" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>You can use <code>before</code> hooks also in your queries, and <a href="#Adding-before-hooks-to-your-read-models">they work as the Read Models ones</a>, with a slight difference: <strong>we don't modify <code>filters</code> but <code>inputs</code> (the parameters sent with a query)</strong>. Apart from that, it's pretty much the same, here's an example:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Query</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">before:</span><span class="hl-1"> [</span><span class="hl-4">CartTotalQuantity</span><span class="hl-1">.</span><span class="hl-4">beforeFn</span><span class="hl-1">],</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CartTotalQuantity</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">cartId</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  @</span><span class="hl-4">nonExposed</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">multiply</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">beforeFn</span><span class="hl-1">(</span><span class="hl-4">input</span><span class="hl-1">: </span><span class="hl-7">QueryInput</span><span class="hl-1">, </span><span class="hl-4">currentUser</span><span class="hl-1">?: </span><span class="hl-7">UserEnvelope</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">QueryInput</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-4">input</span><span class="hl-1">.</span><span class="hl-4">multiply</span><span class="hl-1"> = </span><span class="hl-9">100</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">input</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="reading-events" class="tsd-anchor-link">Reading events<a href="#reading-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>You can also fetch events directly if you need. To do so, there are two kind of queries that have the following structure:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">eventsByEntity</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: &lt;</span><span class="hl-3">name of entity</span><span class="hl-1">&gt;, </span><span class="hl-4">entityID</span><span class="hl-1">: </span><span class="hl-2">&quot;&lt;id of the entity&gt;&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">selection_field_list</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">eventsByType</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1">: &lt;</span><span class="hl-3">name of event</span><span class="hl-1">&gt;) {</span><br/><span class="hl-1">    </span><span class="hl-4">selection_field_list</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Where:</p>
<ul>
<li><em>&lt;name of your entity&gt;</em> is the name of the class corresponding to the entity whose events you want to retrieve.</li>
<li><em>&lt;id of the entity&gt;</em> is the ID of the specific entity instance whose events you are interested in. <strong>This is optional</strong></li>
<li><em>&lt;name of event&gt;</em> is the name of the class corresponding to the event type whose instances you want to retrieve.</li>
<li><em>selection_field_list</em> is a list with the names of the specific fields you want to get as response. See the response example below to know more.</li>
</ul>
<h3 id="examples" class="tsd-anchor-link">Examples<a href="#examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="text">  URL: &quot;&lt;graphqlURL&gt;&quot;
</code><button type="button">Copy</button></pre>

<p><strong>A) Read all events associated with a specific instance (a specific ID) of the entity Cart</strong></p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">eventsByEntity</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">:</span><span class="hl-3"> Cart</span><span class="hl-1">, </span><span class="hl-4">entityID</span><span class="hl-1">: </span><span class="hl-2">&quot;ABC123&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">type</span><br/><span class="hl-1">    </span><span class="hl-4">entity</span><br/><span class="hl-1">    </span><span class="hl-4">entityID</span><br/><span class="hl-1">    </span><span class="hl-4">requestID</span><br/><span class="hl-1">    </span><span class="hl-4">createdAt</span><br/><span class="hl-1">    </span><span class="hl-4">value</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>B) Read all events associated with any instance of the entity Cart</strong></p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">eventsByEntity</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">:</span><span class="hl-3"> Cart</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">type</span><br/><span class="hl-1">    </span><span class="hl-4">entity</span><br/><span class="hl-1">    </span><span class="hl-4">entityID</span><br/><span class="hl-1">    </span><span class="hl-4">requestID</span><br/><span class="hl-1">    </span><span class="hl-4">createdAt</span><br/><span class="hl-1">    </span><span class="hl-4">value</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>For these cases, you would get an array of event <em>envelopes</em> as a response. This means that you get some metadata related to the event along with the event content, which can be found inside the <code>&quot;value&quot;</code> field.</p>
<p>The response look like this:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;data&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-10">&quot;eventsByEntity&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">      {</span><br/><span class="hl-1">        </span><span class="hl-10">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;CartItemChanged&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-10">&quot;entity&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;Cart&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-10">&quot;entityID&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;ABC123&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-10">&quot;requestID&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;7a9cc6a7-7c7f-4ef0-aef1-b226ae4d94fa&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-10">&quot;createdAt&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;2021-05-12T08:41:13.792Z&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-10">&quot;value&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;productId&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;73f7818c-f83e-4482-be49-339c004b6fdf&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;cartId&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;ABC123&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;quantity&quot;</span><span class="hl-1">: </span><span class="hl-9">2</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    ]</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>C) Read events of a specific type</strong></p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">eventsByType</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1">:</span><span class="hl-3"> CartItemChanged</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">type</span><br/><span class="hl-1">    </span><span class="hl-4">entity</span><br/><span class="hl-1">    </span><span class="hl-4">entityID</span><br/><span class="hl-1">    </span><span class="hl-4">requestID</span><br/><span class="hl-1">    </span><span class="hl-4">createdAt</span><br/><span class="hl-1">    </span><span class="hl-4">value</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The response would have the same structure as seen in the previous examples. The only difference is that this time you will get only the events with the type you have specified (&quot;CartItemChanged&quot;)</p>
<h3 id="time-filters" class="tsd-anchor-link">Time filters<a href="#time-filters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Optionally, for any of the previous queries, you can include a <code>from</code> and/or <code>to</code> time filters to get only those events that happened inside that time range. You must use a string with a time in ISO format with any precision you like, for example:</p>
<ul>
<li><code>from:&quot;2021&quot;</code> : Events created on 2021 year or up.</li>
<li><code>from:&quot;2021-02-12&quot; to:&quot;2021-02-13&quot;</code> : Events created during February 12th.</li>
<li><code>from:&quot;2021-03-16T16:16:25.178&quot;</code> : Events created at that date and time, using millisecond precision, or later.</li>
</ul>
<h3 id="time-filters-examples" class="tsd-anchor-link">Time filters examples<a href="#time-filters-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>A) Cart events from February 23rd to July 20th, 2021</strong></p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">eventsByEntity</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">:</span><span class="hl-3"> Cart</span><span class="hl-1">, </span><span class="hl-4">from</span><span class="hl-1">: </span><span class="hl-2">&quot;2021-02-23&quot;</span><span class="hl-1">, </span><span class="hl-4">to</span><span class="hl-1">: </span><span class="hl-2">&quot;2021-07-20&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">type</span><br/><span class="hl-1">    </span><span class="hl-4">entity</span><br/><span class="hl-1">    </span><span class="hl-4">entityID</span><br/><span class="hl-1">    </span><span class="hl-4">requestID</span><br/><span class="hl-1">    </span><span class="hl-4">createdAt</span><br/><span class="hl-1">    </span><span class="hl-4">value</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>B) CartItemChanged events from February 25th to February 28th, 2021</strong></p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">eventsByType</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1">:</span><span class="hl-3"> CartItemChanged</span><span class="hl-1">, </span><span class="hl-4">from</span><span class="hl-1">: </span><span class="hl-2">&quot;2021-02-25&quot;</span><span class="hl-1">, </span><span class="hl-4">to</span><span class="hl-1">: </span><span class="hl-2">&quot;2021-02-28&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">type</span><br/><span class="hl-1">    </span><span class="hl-4">entity</span><br/><span class="hl-1">    </span><span class="hl-4">entityID</span><br/><span class="hl-1">    </span><span class="hl-4">requestID</span><br/><span class="hl-1">    </span><span class="hl-4">createdAt</span><br/><span class="hl-1">    </span><span class="hl-4">value</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="known-limitations" class="tsd-anchor-link">Known limitations<a href="#known-limitations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Subscriptions don't work for the events API yet</li>
<li>You can only query events, but not write them through this API. Use a command for that.</li>
</ul>
<h2 id="filter-pagination-and-projections" class="tsd-anchor-link">Filter, Pagination and Projections<a href="#filter-pagination-and-projections" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="filtering-a-read-model" class="tsd-anchor-link">Filtering a read model<a href="#filtering-a-read-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The Magek GraphQL API provides support for filtering Read Models on <code>queries</code> and <code>subscriptions</code>.</p>
<p>Using the GraphQL API endpoint you can retrieve the schema of your application so you can see what are the filters for every Read Model and its properties. You can filter like this:</p>
<p>Searching for a specific Read Model by <code>id</code></p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">ProductReadModels</span><span class="hl-1">(</span><span class="hl-4">filter</span><span class="hl-1">: {</span><span class="hl-2">id</span><span class="hl-1">: { </span><span class="hl-2">eq</span><span class="hl-1">: </span><span class="hl-2">&quot;test-id&quot;</span><span class="hl-1"> } }) {</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><br/><span class="hl-1">    </span><span class="hl-4">sku</span><br/><span class="hl-1">    </span><span class="hl-4">availability</span><br/><span class="hl-1">    </span><span class="hl-4">price</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="supported-filters" class="tsd-anchor-link">Supported filters<a href="#supported-filters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The currently supported filters are the following ones:</p>
<h4 id="boolean-filters" class="tsd-anchor-link">Boolean filters<a href="#boolean-filters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th style="text-align:left">Filter</th>
<th style="text-align:center">Value</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">eq</td>
<td style="text-align:center">true/false</td>
<td style="text-align:right">Equal to</td>
</tr>
<tr>
<td style="text-align:left">ne</td>
<td style="text-align:center">true/false</td>
<td style="text-align:right">Not equal to</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">ProductReadModels</span><span class="hl-1">(</span><span class="hl-4">filter</span><span class="hl-1">: { </span><span class="hl-2">availability</span><span class="hl-1">: { </span><span class="hl-2">eq</span><span class="hl-1">: </span><span class="hl-3">true</span><span class="hl-1"> } }) {</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><br/><span class="hl-1">    </span><span class="hl-4">sku</span><br/><span class="hl-1">    </span><span class="hl-4">availability</span><br/><span class="hl-1">    </span><span class="hl-4">price</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h4 id="number-filters" class="tsd-anchor-link">Number filters<a href="#number-filters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th style="text-align:left">Filter</th>
<th style="text-align:center">Value</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">eq</td>
<td style="text-align:center">Float</td>
<td style="text-align:right">Equal to</td>
</tr>
<tr>
<td style="text-align:left">ne</td>
<td style="text-align:center">Float</td>
<td style="text-align:right">Not equal to</td>
</tr>
<tr>
<td style="text-align:left">gt</td>
<td style="text-align:center">Float</td>
<td style="text-align:right">Greater than</td>
</tr>
<tr>
<td style="text-align:left">gte</td>
<td style="text-align:center">Float</td>
<td style="text-align:right">Greater or equal than</td>
</tr>
<tr>
<td style="text-align:left">lt</td>
<td style="text-align:center">Float</td>
<td style="text-align:right">Lower than</td>
</tr>
<tr>
<td style="text-align:left">lte</td>
<td style="text-align:center">Float</td>
<td style="text-align:right">Lower or equal than</td>
</tr>
<tr>
<td style="text-align:left">in</td>
<td style="text-align:center">[Float]</td>
<td style="text-align:right">Exists in given array</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">ProductReadModels</span><span class="hl-1">(</span><span class="hl-4">filter</span><span class="hl-1">: { </span><span class="hl-2">price</span><span class="hl-1">: { </span><span class="hl-2">gt</span><span class="hl-1">: </span><span class="hl-9">200</span><span class="hl-1"> } }) {</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><br/><span class="hl-1">    </span><span class="hl-4">sku</span><br/><span class="hl-1">    </span><span class="hl-4">availability</span><br/><span class="hl-1">    </span><span class="hl-4">price</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h4 id="string-filters" class="tsd-anchor-link">String filters<a href="#string-filters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th style="text-align:left">Filter</th>
<th style="text-align:center">Value</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">eq</td>
<td style="text-align:center">String</td>
<td style="text-align:right">Equal to</td>
</tr>
<tr>
<td style="text-align:left">ne</td>
<td style="text-align:center">String</td>
<td style="text-align:right">Not equal to</td>
</tr>
<tr>
<td style="text-align:left">gt</td>
<td style="text-align:center">String</td>
<td style="text-align:right">Greater than</td>
</tr>
<tr>
<td style="text-align:left">gte</td>
<td style="text-align:center">String</td>
<td style="text-align:right">Greater or equal than</td>
</tr>
<tr>
<td style="text-align:left">lt</td>
<td style="text-align:center">String</td>
<td style="text-align:right">Lower than</td>
</tr>
<tr>
<td style="text-align:left">lte</td>
<td style="text-align:center">String</td>
<td style="text-align:right">Lower or equal than</td>
</tr>
<tr>
<td style="text-align:left">in</td>
<td style="text-align:center">[String]</td>
<td style="text-align:right">Exists in given array</td>
</tr>
<tr>
<td style="text-align:left">beginsWith</td>
<td style="text-align:center">String</td>
<td style="text-align:right">Starts with a given substr</td>
</tr>
<tr>
<td style="text-align:left">contains</td>
<td style="text-align:center">String</td>
<td style="text-align:right">Contains a given substr</td>
</tr>
<tr>
<td style="text-align:left">regex*</td>
<td style="text-align:center">String</td>
<td style="text-align:right">Regular expression</td>
</tr>
<tr>
<td style="text-align:left">iRegex*</td>
<td style="text-align:center">String</td>
<td style="text-align:right">Case insensitive Regular expression</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">ProductReadModels</span><span class="hl-1">(</span><span class="hl-4">filter</span><span class="hl-1">: {</span><span class="hl-2">sku</span><span class="hl-1">: { </span><span class="hl-2">begingsWith</span><span class="hl-1">: </span><span class="hl-2">&quot;jewelry&quot;</span><span class="hl-1"> } }) {</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><br/><span class="hl-1">    </span><span class="hl-4">sku</span><br/><span class="hl-1">    </span><span class="hl-4">availability</span><br/><span class="hl-1">    </span><span class="hl-4">price</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Note:</strong>
<code>eq</code> and <code>ne</code> are valid filters for checking if a field value is null or not null.</p>
</blockquote>
<h4 id="array-filters" class="tsd-anchor-link">Array filters<a href="#array-filters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th style="text-align:left">Filter</th>
<th style="text-align:center">Value</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">includes</td>
<td style="text-align:center">Object</td>
<td style="text-align:right">Includes a given object</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">CartReadModels</span><span class="hl-1">(</span><span class="hl-4">filter</span><span class="hl-1">: { </span><span class="hl-2">itemsIds</span><span class="hl-1">: { </span><span class="hl-2">includes</span><span class="hl-1">: </span><span class="hl-2">&quot;test-item&quot;</span><span class="hl-1"> } }) {</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><br/><span class="hl-1">    </span><span class="hl-4">price</span><br/><span class="hl-1">    </span><span class="hl-4">itemsIds</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Note:</strong>
Right now, with complex properties in Arrays, you just can filter them if you know the exact value of an element but is not possible to filter from a property of the element. As a workaround, you can use an array of ids of the complex property and filter for that property as in the example above.</p>
</blockquote>
<h4 id="filter-combinators" class="tsd-anchor-link">Filter combinators<a href="#filter-combinators" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>All the filters can be combined to create a more complex search on the same properties of the ReadModel.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Filter</th>
<th style="text-align:center">Value</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">and</td>
<td style="text-align:center">[Filters]</td>
<td style="text-align:right">AND - all filters on the list have a match</td>
</tr>
<tr>
<td style="text-align:left">or</td>
<td style="text-align:center">[Filters]</td>
<td style="text-align:right">OR - At least one filter of the list has a match</td>
</tr>
<tr>
<td style="text-align:left">not</td>
<td style="text-align:center">Filter/and/or</td>
<td style="text-align:right">The element does not match the filter</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">CartReadModels</span><span class="hl-1">(</span><span class="hl-4">filter</span><span class="hl-1">: { </span><span class="hl-2">or</span><span class="hl-1">: [{ </span><span class="hl-2">id</span><span class="hl-1">: { </span><span class="hl-2">contains</span><span class="hl-1">: </span><span class="hl-2">&quot;a&quot;</span><span class="hl-1"> } }, { </span><span class="hl-2">id</span><span class="hl-1">: { </span><span class="hl-2">contains</span><span class="hl-1">: </span><span class="hl-2">&quot;b&quot;</span><span class="hl-1"> } }] }) {</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><br/><span class="hl-1">    </span><span class="hl-4">price</span><br/><span class="hl-1">    </span><span class="hl-4">itemsIds</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h4 id="isdefined-operator" class="tsd-anchor-link">IsDefined operator<a href="#isdefined-operator" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th style="text-align:left">Filter</th>
<th style="text-align:center">Value</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">isDefined</td>
<td style="text-align:center">true/false</td>
<td style="text-align:right">field exists or not</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">CartReadModels</span><span class="hl-1">(</span><span class="hl-4">filter</span><span class="hl-1">: { </span><span class="hl-2">price</span><span class="hl-1">: { </span><span class="hl-2">isDefined</span><span class="hl-1">: </span><span class="hl-3">true</span><span class="hl-1"> } }) {</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><br/><span class="hl-1">    </span><span class="hl-4">price</span><br/><span class="hl-1">    </span><span class="hl-4">itemsIds</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="getting-filtering-and-projecting-read-models-data-at-code-level" class="tsd-anchor-link">Getting, filtering and projecting read models data at code level<a href="#getting-filtering-and-projecting-read-models-data-at-code-level" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Magek allows you to get your read models data in your commands handlers and event handlers using the <code>Magek.readModel</code> method.</p>
<p>For example, you can filter and get the total number of the products that meet your criteria in your commands like this:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">GetProductsCount</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">filters</span><span class="hl-1">!: </span><span class="hl-7">Record</span><span class="hl-1">&lt;</span><span class="hl-7">string</span><span class="hl-1">, </span><span class="hl-7">any</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">searcher</span><span class="hl-1"> = </span><span class="hl-4">Magek</span><span class="hl-1">.</span><span class="hl-0">readModel</span><span class="hl-1">(</span><span class="hl-4">ProductReadModel</span><span class="hl-1">)</span><br/><br/><span class="hl-1">    </span><span class="hl-4">searcher</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">({</span><br/><span class="hl-1">      </span><span class="hl-4">sku:</span><span class="hl-1"> { </span><span class="hl-4">contains:</span><span class="hl-1"> </span><span class="hl-2">&#39;toy&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">      </span><span class="hl-4">or:</span><span class="hl-1"> [</span><br/><span class="hl-1">        {</span><br/><span class="hl-1">          </span><span class="hl-4">description:</span><span class="hl-1"> { </span><span class="hl-4">contains:</span><span class="hl-1"> </span><span class="hl-2">&#39;fancy&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">        {</span><br/><span class="hl-1">          </span><span class="hl-4">description:</span><span class="hl-1"> { </span><span class="hl-4">contains:</span><span class="hl-1"> </span><span class="hl-2">&#39;great&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">      ],</span><br/><span class="hl-1">    })</span><br/><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">searcher</span><span class="hl-1">.</span><span class="hl-0">search</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> { </span><span class="hl-4">count:</span><span class="hl-1"> </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>You can select which fields you want to get in your read model using the <code>select</code> method:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">GetProductsCount</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">filters</span><span class="hl-1">!: </span><span class="hl-7">Record</span><span class="hl-1">&lt;</span><span class="hl-7">string</span><span class="hl-1">, </span><span class="hl-7">any</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">unknown</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">searcher</span><span class="hl-1"> = </span><span class="hl-4">Magek</span><span class="hl-1">.</span><span class="hl-0">readModel</span><span class="hl-1">(</span><span class="hl-4">ProductReadModel</span><span class="hl-1">)</span><br/><span class="hl-1">            .</span><span class="hl-0">filter</span><span class="hl-1">({</span><br/><span class="hl-1">              </span><span class="hl-4">sku:</span><span class="hl-1"> { </span><span class="hl-4">contains:</span><span class="hl-1"> </span><span class="hl-2">&#39;toy&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">              </span><span class="hl-4">or:</span><span class="hl-1"> [</span><br/><span class="hl-1">                {</span><br/><span class="hl-1">                  </span><span class="hl-4">description:</span><span class="hl-1"> { </span><span class="hl-4">contains:</span><span class="hl-1"> </span><span class="hl-2">&#39;fancy&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">                },</span><br/><span class="hl-1">                {</span><br/><span class="hl-1">                  </span><span class="hl-4">description:</span><span class="hl-1"> { </span><span class="hl-4">contains:</span><span class="hl-1"> </span><span class="hl-2">&#39;great&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">                },</span><br/><span class="hl-1">              ],</span><br/><span class="hl-1">            })</span><br/><span class="hl-1">            .</span><span class="hl-0">select</span><span class="hl-1">([</span><span class="hl-2">&#39;sku&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;description&#39;</span><span class="hl-1">])</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">searcher</span><span class="hl-1">.</span><span class="hl-0">search</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> { </span><span class="hl-4">count:</span><span class="hl-1"> </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The searcher result using <code>select</code> will generate an array of objects with the <code>sku</code> and <code>description</code> fields of the <code>ProductReadModel</code> read model. If you don't use <code>select</code> the result will be an array of <code>ProductReadModel</code> instances.
You can also select properties in objects which are part of an array property in a model. For that, the parent array properties need to be notated with the <code>[]</code> suffix. For example:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">GetCartItems</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">filters</span><span class="hl-1">!: </span><span class="hl-7">Record</span><span class="hl-1">&lt;</span><span class="hl-7">string</span><span class="hl-1">, </span><span class="hl-7">any</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">unknown</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">searcher</span><span class="hl-1"> = </span><span class="hl-4">Magek</span><span class="hl-1">.</span><span class="hl-0">readModel</span><span class="hl-1">(</span><span class="hl-4">CartReadModel</span><span class="hl-1">)</span><br/><span class="hl-1">            .</span><span class="hl-0">select</span><span class="hl-1">([</span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;cartItems[].productId&#39;</span><span class="hl-1">])</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">searcher</span><span class="hl-1">.</span><span class="hl-0">search</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> { </span><span class="hl-4">count:</span><span class="hl-1"> </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The above search will return an array of carts with their <code>id</code> property, as well as an array of the <code>cartItems</code> of each cart with only the <code>productId</code> for each item.</p>
<blockquote>
<p><strong>Warning:</strong>
Using <code>select</code> will skip any Read Models migrations that need to be applied to the result. If you need to apply migrations to the result, don't use <code>select</code>.</p>
</blockquote>
<blockquote>
<p><strong>Warning:</strong>
Support for selecting fields from objects inside arrays is limited to arrays that are at most nested inside another property, e.g., <code>['category.relatedCategories[].name']</code>. Selecting fields from arrays that are nested deeper than that (e.g., <code>['foo.bar.items[].id']</code>) will return the entire object.</p>
</blockquote>
<blockquote>
<p><strong>Warning:</strong>
Notice that <code>ReadModel</code>s are eventually consistent objects that are calculated as all events in all entities that affect the read model are settled. You should not assume that a read model is a proper source of truth, so you shouldn't use this feature for data validations. If you need to query the most up-to-date current state, consider fetching your Entities, instead of ReadModels, with <code>Magek.entity</code></p>
</blockquote>
<h3 id="using-sorting" class="tsd-anchor-link">Using sorting<a href="#using-sorting" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Magek allows you to sort your read models data in your commands handlers and event handlers using the <code>Magek.readModel</code> method.</p>
<p>For example, you can sort and get the products in your commands like this:</p>
<pre><code class="graphql"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-4">ListCartReadModels</span><span class="hl-1">(</span><span class="hl-4">filter</span><span class="hl-1">: {}, </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-9">5</span><span class="hl-1">, </span><span class="hl-4">sortBy</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-2">shippingAddress</span><span class="hl-1">: {</span><br/><span class="hl-1">      </span><span class="hl-2">firstName</span><span class="hl-1">:</span><span class="hl-3"> ASC</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }) {</span><br/><span class="hl-1">    </span><span class="hl-4">items</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">id</span><br/><span class="hl-1">      </span><span class="hl-4">cartItems</span><span class="hl-1"> </span><br/><span class="hl-1">      </span><span class="hl-4">checks</span><br/><span class="hl-1">      </span><span class="hl-4">shippingAddress</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">firstName</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">      </span><span class="hl-4">payment</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">cartId</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">      </span><span class="hl-4">cartItemsIds</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-4">cursor</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This is a preview feature with some limitations:</p>
<ul>
<li>Sort by one field supported.</li>
<li>Nested fields supported.</li>
<li>Sort by more than one field: <strong>unsupported</strong>.</li>
</ul>
<blockquote>
<p><strong>Warning:</strong>
It is not possible to sort by fields defined as Interface, only classes or primitives types.</p>
</blockquote>
<h3 id="using-pagination" class="tsd-anchor-link">Using pagination<a href="#using-pagination" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The Magek GraphQL API includes a type for your read models that stands for <code>List{&quot;your-read-model-name&quot;}</code>, which is the official way to work with pagination. Alternative, there is another type without the <code>List</code> prefix, which will be deprecated in future versions.</p>
<p>The Read Model List type includes some new parameters that can be used on queries:</p>
<ul>
<li><code>limit</code>; an integer that specifies the maximum number of items to be returned.</li>
<li><code>afterCursor</code>; a parameter to set the <code>cursor</code> property returned by the previous query, if not null.</li>
</ul>
<p>Example:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">ListProductReadModels</span><br/><span class="hl-1">  (</span><br/><span class="hl-1">    </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-9">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">afterCursor</span><span class="hl-1">: { </span><span class="hl-2">id</span><span class="hl-1">: </span><span class="hl-2">&quot;last-page-item&quot;</span><span class="hl-1">}</span><br/><span class="hl-1">  ) {</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><br/><span class="hl-1">    </span><span class="hl-4">sku</span><br/><span class="hl-1">    </span><span class="hl-4">availability</span><br/><span class="hl-1">    </span><span class="hl-4">price</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Besides the parameters, this type also returns a type <code>{your-read-model-name}Connection</code>, it includes the following properties:</p>
<ul>
<li><code>cursor</code>; if there are more results to paginate, it will return the object to pass to the <code>afterCursor</code> parameter on the next query. If there aren't more items to be shown, it will be undefined.</li>
<li><code>items</code>; the list of items returned by the query, if there aren't any, it will be an empty list.</li>
</ul>
<h2 id="using-apollo-client" class="tsd-anchor-link">Using Apollo Client<a href="#using-apollo-client" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>One of the best clients to connect to a GraphQL API is the <a href="https://www.apollographql.com/">Apollo</a> client. There will probably be a version for your client technology of choice. These are the main ones:</p>
<ul>
<li><a href="https://www.apollographql.com/docs/react/">For Javascript/Typescript</a> (<a href="https://github.com/apollographql/apollo-client">Github</a>)</li>
<li><a href="https://www.apollographql.com/docs/ios/">For iOS</a> (<a href="https://github.com/apollographql/apollo-ios">Github)</a>)</li>
<li><a href="https://www.apollographql.com/docs/android/">For Java/Kotlin/Android</a> (<a href="https://github.com/apollographql/apollo-android">Github</a>)</li>
</ul>
<p>We recommend referring to the documentation of those clients to know how to use them. Here is an example of how to fully instantiate the Javascript client so that it works for queries, mutations and subscriptions:</p>
<pre><code class="typescript"><br/><span class="hl-5">// Helper function that checks if a GraphQL operation is a subscription or not</span><br/><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">isSubscriptionOperation</span><span class="hl-1">({ </span><span class="hl-4">query</span><span class="hl-1"> }) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">definition</span><span class="hl-1"> = </span><span class="hl-0">getMainDefinition</span><span class="hl-1">(</span><span class="hl-4">query</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">definition</span><span class="hl-1">.</span><span class="hl-4">kind</span><span class="hl-1"> === </span><span class="hl-2">&#39;OperationDefinition&#39;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">definition</span><span class="hl-1">.</span><span class="hl-4">operation</span><span class="hl-1"> === </span><span class="hl-2">&#39;subscription&#39;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Create an HTTP link for sending queries and mutations</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">httpLink</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">HttpLink</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">uri:</span><span class="hl-1"> </span><span class="hl-2">&#39;&lt;graphqlURL&gt;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><br/><span class="hl-5">// Create a SusbscriptionClient and a WebSocket link for sending subscriptions</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">subscriptionClient</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">SubscriptionClient</span><span class="hl-1">(</span><span class="hl-2">&#39;&lt;websocketURL&gt;&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">reconnect:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">wsLink</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">WebSocketLink</span><span class="hl-1">(</span><span class="hl-4">subscriptionClient</span><span class="hl-1">)</span><br/><br/><span class="hl-5">// Combine both links so that depending on the operation, it uses one or another</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">splitLink</span><span class="hl-1"> = </span><span class="hl-0">split</span><span class="hl-1">(</span><span class="hl-4">isSubscriptionOperation</span><span class="hl-1">, </span><span class="hl-4">wsLink</span><span class="hl-1">, </span><span class="hl-4">httpLink</span><span class="hl-1">)</span><br/><br/><span class="hl-5">// Finally, create the client using the link created above</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">client</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ApolloClient</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">link:</span><span class="hl-1"> </span><span class="hl-4">splitLink</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">cache:</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">InMemoryCache</span><span class="hl-1">(),</span><br/><span class="hl-1">})</span>
</code><button type="button">Copy</button></pre>

<p>Now, we can send queries, mutations and subscriptions using the <code>client</code> instance:</p>
<pre><code class="typescript"><br/><span class="hl-5">// Query the CartReadModel</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">readModelData</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">client</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">variables:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">cartID:</span><span class="hl-1"> </span><span class="hl-2">&#39;demo&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">query:</span><span class="hl-1"> </span><span class="hl-0">gql</span><span class="hl-2">`</span><br/><span class="hl-2">    query QueryCart($cartID: ID!) {</span><br/><span class="hl-2">      CartReadModel(id: $cartID) {</span><br/><span class="hl-2">        id</span><br/><span class="hl-2">        items</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  `</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><br/><span class="hl-5">// Send a command (mutation)</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">commandResult</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">client</span><span class="hl-1">.</span><span class="hl-0">mutate</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">variables:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">cartID:</span><span class="hl-1"> </span><span class="hl-2">&#39;demo&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">sku:</span><span class="hl-1"> </span><span class="hl-2">&#39;ABC_02&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">mutation:</span><span class="hl-1"> </span><span class="hl-0">gql</span><span class="hl-2">`</span><br/><span class="hl-2">    mutation AddOneItemToCart($cartID: ID!, $sku: string!) {</span><br/><span class="hl-2">      ChangeCart(input: { cartId: $cartID, sku: $sku, quantity: 1 })</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  `</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><br/><span class="hl-5">// Subscribe to changes in the CartReadModel</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">subscriptionOperation</span><span class="hl-1"> = </span><span class="hl-4">client</span><span class="hl-1">.</span><span class="hl-0">subscribe</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">variables:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">cartID:</span><span class="hl-1"> </span><span class="hl-2">&#39;demo&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">query:</span><span class="hl-1"> </span><span class="hl-0">gql</span><span class="hl-2">`</span><br/><span class="hl-2">    subscription SubscribeToCart($cartID: ID!) {</span><br/><span class="hl-2">      CartReadModel(id: $cartID) {</span><br/><span class="hl-2">        id</span><br/><span class="hl-2">        cartItems</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  `</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><br/><span class="hl-4">subscriptionOperation</span><span class="hl-1">.</span><span class="hl-0">subscribe</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-0">next</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">cartReadModel</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// This function is called everytime the CartReadModel with ID=&quot;demo&quot; is changed</span><br/><span class="hl-1">    </span><span class="hl-5">// Parameter &quot;cartReadModel&quot; contains the latest version of the cart</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">})</span>
</code><button type="button">Copy</button></pre>

<h2 id="authorizing-operations" class="tsd-anchor-link">Authorizing operations<a href="#authorizing-operations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>When you have a command or read model whose access is authorized to users with a specific set of roles (see <a href="#authentication-and-authorization">Authentication and Authorization</a>), you need to use an authorization token to send queries, mutations or subscriptions to that command or read model.</p>
<p>You can use any JWT-based authentication provider to issue tokens. Once you have a token, the way to send it varies depending on the protocol you are using to send GraphQL operations:</p>
<ul>
<li>For <strong>HTTP</strong>, you need to send the HTTP header <code>Authorization</code> with the token, making sure you prefix it with <code>Bearer</code> (the kind of token Magek uses). For example:</li>
</ul>
<pre><code class="http"><span class="hl-14">Authorization</span><span class="hl-3">:</span><span class="hl-1"> </span><span class="hl-2">Bearer &lt;your token&gt;</span>
</code><button type="button">Copy</button></pre>

<ul>
<li>For <strong>WebSocket</strong>, you need to adhere to the <a href="#the-graphql-over-websocket-protocol">GraphQL over WebSocket protocol</a> to send authorization data. The way to do that is by sending the token in the payload of the first message you send when initializing the connection (see <a href="#subscribing-to-read-models">Subscribing to read models</a>). For example:</li>
</ul>
<pre><code class="json"><span class="hl-1">{ </span><span class="hl-10">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;connection_init&quot;</span><span class="hl-1">, </span><span class="hl-10">&quot;payload&quot;</span><span class="hl-1">: { </span><span class="hl-10">&quot;Authorization&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;&lt;your token&gt;&quot;</span><span class="hl-1"> } }</span>
</code><button type="button">Copy</button></pre>

<p>You normally won't be sending tokens in such a low-level way. GraphQL clients have easier ways to send these tokens. See <a href="#sending-tokens-with-apollo-clients">Sending tokens with Apollo client</a></p>
<h3 id="sending-tokens-with-apollo-clients" class="tsd-anchor-link">Sending tokens with Apollo clients<a href="#sending-tokens-with-apollo-clients" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>We recommend going to the specific documentation of the specific Apollo client you are using to know how to send tokens. However, the basics of this guide remains the same. Here is an example of how you would configure the Javascript/Typescript Apollo client to send the authorization token. The example is exactly the same as the one shown in the <a href="#using-apollo-client">Using Apollo clients</a> section, but with the changes needed to send the token.</p>
<pre><code class="typescript"><br/><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">isSubscriptionOperation</span><span class="hl-1">({ </span><span class="hl-4">query</span><span class="hl-1"> }) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">definition</span><span class="hl-1"> = </span><span class="hl-0">getMainDefinition</span><span class="hl-1">(</span><span class="hl-4">query</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">definition</span><span class="hl-1">.</span><span class="hl-4">kind</span><span class="hl-1"> === </span><span class="hl-2">&#39;OperationDefinition&#39;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">definition</span><span class="hl-1">.</span><span class="hl-4">operation</span><span class="hl-1"> === </span><span class="hl-2">&#39;subscription&#39;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">httpLink</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">HttpLink</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">uri:</span><span class="hl-1"> </span><span class="hl-2">&#39;&lt;graphqlURL&gt;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><br/><span class="hl-5">// Create an &quot;authLink&quot; that modifies the operation by adding the token to the headers</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">authLink</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ApolloLink</span><span class="hl-1">((</span><span class="hl-4">operation</span><span class="hl-1">, </span><span class="hl-4">forward</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">operation</span><span class="hl-1">.</span><span class="hl-0">setContext</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">headers:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">Authorization:</span><span class="hl-1"> </span><span class="hl-2">&#39;Bearer &lt;idToken&gt;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-0">forward</span><span class="hl-1">(</span><span class="hl-4">operation</span><span class="hl-1">)</span><br/><span class="hl-1">})</span><br/><br/><span class="hl-5">// Concatenate the links so that the &quot;httpLink&quot; receives the operation with the headers set by the &quot;authLink&quot;</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">httpLinkWithAuth</span><span class="hl-1"> = </span><span class="hl-4">authLink</span><span class="hl-1">.</span><span class="hl-0">concat</span><span class="hl-1">(</span><span class="hl-4">httpLink</span><span class="hl-1">)</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">subscriptionClient</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">SubscriptionClient</span><span class="hl-1">(</span><span class="hl-2">&#39;&lt;websocketURL&gt;&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">reconnect:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">// Add a &quot;connectionParam&quot; property with a function that returns the `Authorization` header containing our token</span><br/><span class="hl-1">  </span><span class="hl-0">connectionParams</span><span class="hl-4">:</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">Authorization:</span><span class="hl-1"> </span><span class="hl-2">&#39;Bearer &lt;idToken&gt;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">})</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">wsLink</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">WebSocketLink</span><span class="hl-1">(</span><span class="hl-4">subscriptionClient</span><span class="hl-1">)</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">splitLink</span><span class="hl-1"> = </span><span class="hl-0">split</span><span class="hl-1">(</span><span class="hl-4">isSubscriptionOperation</span><span class="hl-1">, </span><span class="hl-4">wsLink</span><span class="hl-1">, </span><span class="hl-4">httpLinkWithAuth</span><span class="hl-1">)</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">client</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ApolloClient</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">link:</span><span class="hl-1"> </span><span class="hl-4">splitLink</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">cache:</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">InMemoryCache</span><span class="hl-1">(),</span><br/><span class="hl-1">})</span>
</code><button type="button">Copy</button></pre>

<h3 id="refreshing-tokens-with-apollo-clients" class="tsd-anchor-link">Refreshing tokens with Apollo clients<a href="#refreshing-tokens-with-apollo-clients" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Authorization tokens expire after a certain amount of time. When a token is expired, you will get an error and you will need to refresh the token using your authentication provider. After you have done so, you need to use the new token in your GraphQL operations.</p>
<p>There are several ways to do this. Here we show the simplest one for learning purposes.</p>
<p>First, we modify the example shown in the section <a href="#sending-tokens-with-apollo-clients">Sending tokens with apollo clients</a> so that the token is stored in a global variable and the Apollo links get the token from it. That variable will be updated when the user signs-in and the token is refreshed:</p>
<pre><code class="typescript"><br/><span class="hl-3">let</span><span class="hl-1"> </span><span class="hl-4">authToken</span><span class="hl-1"> = </span><span class="hl-3">undefined</span><span class="hl-1"> </span><span class="hl-5">// &lt;-- CHANGED: This variable will hold the token and will be updated everytime the token is refreshed</span><br/><br/><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">isSubscriptionOperation</span><span class="hl-1">({ </span><span class="hl-4">query</span><span class="hl-1"> }) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">definition</span><span class="hl-1"> = </span><span class="hl-0">getMainDefinition</span><span class="hl-1">(</span><span class="hl-4">query</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">definition</span><span class="hl-1">.</span><span class="hl-4">kind</span><span class="hl-1"> === </span><span class="hl-2">&#39;OperationDefinition&#39;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">definition</span><span class="hl-1">.</span><span class="hl-4">operation</span><span class="hl-1"> === </span><span class="hl-2">&#39;subscription&#39;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">httpLink</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">HttpLink</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">uri:</span><span class="hl-1"> </span><span class="hl-2">&#39;&lt;AuthApiEndpoint&gt;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">authLink</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ApolloLink</span><span class="hl-1">((</span><span class="hl-4">operation</span><span class="hl-1">, </span><span class="hl-4">forward</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-4">authToken</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">operation</span><span class="hl-1">.</span><span class="hl-0">setContext</span><span class="hl-1">({</span><br/><span class="hl-1">      </span><span class="hl-4">headers:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">Authorization:</span><span class="hl-1"> </span><span class="hl-2">`Bearer </span><span class="hl-3">${</span><span class="hl-4">authToken</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">, </span><span class="hl-5">// &lt;-- CHANGED: We use the &quot;authToken&quot; global variable</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">    })</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-0">forward</span><span class="hl-1">(</span><span class="hl-4">operation</span><span class="hl-1">)</span><br/><span class="hl-1">})</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">httpLinkWithAuth</span><span class="hl-1"> = </span><span class="hl-4">authLink</span><span class="hl-1">.</span><span class="hl-0">concat</span><span class="hl-1">(</span><span class="hl-4">httpLink</span><span class="hl-1">)</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">subscriptionClient</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">SubscriptionClient</span><span class="hl-1">(</span><span class="hl-2">&#39;&lt;websocketURL&gt;&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">reconnect:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">// CHANGED: added a &quot;connectionParam&quot; property with a function that returns the `Authorizaiton` header containing our token</span><br/><span class="hl-1">  </span><span class="hl-0">connectionParams</span><span class="hl-4">:</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-4">authToken</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-6">return</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">Authorization:</span><span class="hl-1"> </span><span class="hl-2">`Bearer </span><span class="hl-3">${</span><span class="hl-4">authToken</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">, </span><span class="hl-5">// &lt;-- CHANGED: We use the &quot;authToken&quot; global variable</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> {}</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">})</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">wsLink</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">WebSocketLink</span><span class="hl-1">(</span><span class="hl-4">subscriptionClient</span><span class="hl-1">)</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">splitLink</span><span class="hl-1"> = </span><span class="hl-0">split</span><span class="hl-1">(</span><span class="hl-4">isSubscriptionOperation</span><span class="hl-1">, </span><span class="hl-4">wsLink</span><span class="hl-1">, </span><span class="hl-4">httpLinkWithAuth</span><span class="hl-1">)</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">client</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ApolloClient</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">link:</span><span class="hl-1"> </span><span class="hl-4">splitLink</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">cache:</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">InMemoryCache</span><span class="hl-1">(),</span><br/><span class="hl-1">})</span>
</code><button type="button">Copy</button></pre>

<p>Now, <em>when the user signs-in</em> or <em>when the token is refreshed</em>, we need to do two things:</p>
<ol>
<li>Update the global variable <code>authToken</code> with the new token.</li>
<li>Reconnect the socket used by the subscription client by doing <code>subscriptionClient.close(false)</code>.</li>
</ol>
<p>You might be wondering why we need to do the second step. The reason is that, with operations sent through HTTP, the token goes along with every operation, in the headers. However, with operations sent through WebSockets, like subscriptions, the token is only sent when the socket connection is established. For this reason, <strong>everytime we update the token we need to reconnect the <code>SubscriptionClient</code></strong> so that it sends again the token (the updated one in this case).</p>
<h2 id="the-graphql-over-websocket-protocol" class="tsd-anchor-link">The GraphQL over WebSocket protocol<a href="#the-graphql-over-websocket-protocol" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Sockets are channels for two-way communication that doesn't follow the request-response cycle, a characteristic feature of the HTTP protocol. One part can send many messages and the other part can receive all of them but only answer to some specific ones. What is more, messages could come in any order. For example, one part can send two messages and receive the response of the second message before the response of the first message.</p>
<p>For these reasons, in order to have an effective non-trivial communication through sockets, a sub-protocol is needed. It would be in charge of making both parts understand each other, share authentication tokens, matching response to the corresponding requests, etc.</p>
<p>The Magek WebSocket communication uses the &quot;GraphQL over WebSocket&quot; protocol as subprotocol. It is in charge of all the low level stuff needed to properly send subscription operations to read models and receive the corresponding data.</p>
<p>You don't need to know anything about this to develop using Magek, neither in the backend side nor in the frontend side (as all the Apollo GraphQL clients uses this protocol), but it is good to know it is there to guarantee a proper communication. In case you are really curious, you can read about the protocol <a href="https://github.com/apollographql/subscriptions-transport-ws/blob/master/PROTOCOL.md">here</a>.</p>
<blockquote>
<p><strong>Note:</strong>
The WebSocket communication in Magek only supports this subprotocol, whose identifier is <code>graphql-ws</code>. For this reason, when you connect to the WebSocket provisioned by Magek, you must specify the <code>graphql-ws</code> subprotocol. If not, the connection won't succeed.</p>
</blockquote>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#graphql-api"><span>Graph<wbr/>QL <wbr/>API</span></a><ul><li><a href="#relationship-between-graphql-operations-and-commands-and-read-models"><span>Relationship between <wbr/>Graph<wbr/>QL operations and commands and read models</span></a></li><li><a href="#how-to-send-graphql-request"><span>How to send <wbr/>Graph<wbr/>QL request</span></a></li><li><a href="#get-graphql-schema-from-your-application"><span>Get <wbr/>Graph<wbr/>QL schema from your application</span></a></li><li><a href="#sending-commands"><span>Sending commands</span></a></li><li><a href="#reading-read-models"><span>Reading read models</span></a></li><li><a href="#subscribing-to-read-models"><span>Subscribing to read models</span></a></li><li><a href="#non-exposing-properties-and-parameters"><span>Non exposing properties and parameters</span></a></li><li><a href="#adding-before-hooks-to-your-read-models"><span>Adding before hooks to your read models</span></a></li><li><a href="#adding-before-hooks-to-your-commands"><span>Adding before hooks to your commands</span></a></li><li><a href="#adding-before-hooks-to-your-queries"><span>Adding before hooks to your queries</span></a></li><li><a href="#reading-events"><span>Reading events</span></a></li><li><ul><li><a href="#examples"><span>Examples</span></a></li><li><a href="#time-filters"><span>Time filters</span></a></li><li><a href="#time-filters-examples"><span>Time filters examples</span></a></li><li><a href="#known-limitations"><span>Known limitations</span></a></li></ul></li><li><a href="#filter-pagination-and-projections"><span>Filter, <wbr/>Pagination and <wbr/>Projections</span></a></li><li><ul><li><a href="#filtering-a-read-model"><span>Filtering a read model</span></a></li><li><a href="#supported-filters"><span>Supported filters</span></a></li><li><ul><li><a href="#boolean-filters"><span>Boolean filters</span></a></li><li><a href="#number-filters"><span>Number filters</span></a></li><li><a href="#string-filters"><span>String filters</span></a></li><li><a href="#array-filters"><span>Array filters</span></a></li><li><a href="#filter-combinators"><span>Filter combinators</span></a></li><li><a href="#isdefined-operator"><span>Is<wbr/>Defined operator</span></a></li></ul></li><li><a href="#getting-filtering-and-projecting-read-models-data-at-code-level"><span>Getting, filtering and projecting read models data at code level</span></a></li><li><a href="#using-sorting"><span>Using sorting</span></a></li><li><a href="#using-pagination"><span>Using pagination</span></a></li></ul></li><li><a href="#using-apollo-client"><span>Using <wbr/>Apollo <wbr/>Client</span></a></li><li><a href="#authorizing-operations"><span>Authorizing operations</span></a></li><li><ul><li><a href="#sending-tokens-with-apollo-clients"><span>Sending tokens with <wbr/>Apollo clients</span></a></li><li><a href="#refreshing-tokens-with-apollo-clients"><span>Refreshing tokens with <wbr/>Apollo clients</span></a></li></ul></li><li><a href="#the-graphql-over-websocket-protocol"><span>The <wbr/>Graph<wbr/>QL over <wbr/>Web<wbr/>Socket protocol</span></a></li></ul></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/theam/magek" class="tsd-nav-link">GitHub</a></nav><nav class="tsd-navigation"><a href="../index.html">Magek Framework</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
