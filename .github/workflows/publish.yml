name: Publish to npm

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0). If empty, uses rush change files for automatic bump.'
        required: false
        type: string

permissions:
  id-token: write   # Required for OIDC
  contents: write   # Required to push version commits/tags

env:
  CI: true

jobs:
  # Check if there are actual changes that require publishing
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for publishable changes
        id: check
        run: |
          # If a specific version is provided, always allow publishing
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "Version override provided, allowing publish"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if there are change files with publishable change types (patch, minor, major)
          # Change files with type "none" should not trigger a publish
          PUBLISHABLE_CHANGES=0
          for file in $(find common/changes -type f -name "*.json" 2>/dev/null); do
            # Check if any change in the file has a publishable type
            if grep -qE '"type":\s*"(patch|minor|major)"' "$file"; then
              echo "Found publishable change in: $file"
              PUBLISHABLE_CHANGES=$((PUBLISHABLE_CHANGES + 1))
            fi
          done

          if [[ $PUBLISHABLE_CHANGES -gt 0 ]]; then
            echo "Found $PUBLISHABLE_CHANGES change file(s) with publishable types"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No publishable change files found. Run 'rush change' to create change files before releasing."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  # Run e2e tests before publishing
  e2e-tests:
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'
    uses: ./.github/workflows/wf_test-e2e.yml

  publish:
    needs: [check-changes, e2e-tests]
    if: needs.check-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: npm-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Upgrade npm for OIDC support
        # npm 11.5.1+ required for OIDC trusted publishing
        run: npm install -g npm@latest

      - name: Enable corepack
        run: corepack enable

      - name: Install Rush
        run: npm install -g @microsoft/rush

      - name: Install dependencies
        run: rush install

      - name: Verify change files
        if: ${{ github.event.inputs.version == '' }}
        run: rush change --verify

      - name: Lint check
        run: rush lint:check

      - name: Build
        run: rush build

      - name: Run unit tests
        run: rush test

      # E2E tests already ran in the e2e-tests job

      - name: Bump versions
        id: bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Use override version if provided, otherwise auto-bump
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "Using override version: ${{ github.event.inputs.version }}"
            rush version --override-version ${{ github.event.inputs.version }}
          else
            rush version --bump
          fi

          # Commit version changes if there are any
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .
            git commit --no-verify -m "chore: bump versions [skip ci]"
          fi

          # Extract the new version from the main package
          VERSION=$(node -p "require('./packages/core/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Push version changes
        # Push BEFORE npm publish to ensure git state is saved even if publish fails
        run: git push origin main

      - name: Publish packages
        # OIDC trusted publishing: npm automatically uses GitHub's OIDC token
        # No NPM_TOKEN secret needed - configure trusted publishers on npmjs.com
        # Provenance attestations are automatically generated with trusted publishing
        run: >-
          rush publish --publish --include-all
          --set-access-level public --apply

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          generate_release_notes: true

      - name: Build landing page
        run: |
          VERSION=${{ steps.bump.outputs.version }}
          echo "Building landing page with documentation link to v${VERSION}"
          npm install marked
          node scripts/build-landing-page.js $VERSION

      - name: Build versioned documentation
        run: |
          VERSION=${{ steps.bump.outputs.version }}
          echo "Building documentation for version $VERSION"

          # Build documentation
          rush docs:build

          # Move built docs to versioned folder
          mkdir -p common/temp/versioned-docs/v${VERSION}
          mv common/temp/docs-site/* common/temp/versioned-docs/v${VERSION}/

      - name: Checkout gh-pages branch
        uses: actions/checkout@v6
        with:
          ref: gh-pages
          path: gh-pages
          # Use default token - gh-pages branch should exist

      - name: Update gh-pages with new version
        run: |
          VERSION=${{ steps.bump.outputs.version }}

          # Copy landing page to root (replaces existing redirect)
          cp common/temp/landing-page/index.html gh-pages/index.html

          # Copy new version folder
          cp -r common/temp/versioned-docs/v${VERSION} gh-pages/v${VERSION}

          # Update versions.json manifest
          node scripts/update-versions-manifest.js gh-pages/versions.json $VERSION

      - name: Commit and push to gh-pages
        run: |
          VERSION=${{ steps.bump.outputs.version }}
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "docs: publish v${VERSION} documentation"
          git push origin gh-pages
