name: Publish to npm

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0). If empty, uses rush change files for automatic bump.'
        required: false
        type: string

permissions:
  id-token: write   # Required for OIDC
  contents: write   # Required to push version commits/tags
  pages: write      # Required for docs-deploy workflow

env:
  CI: true

jobs:
  # Check if there are actual changes that require publishing
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for publishable changes
        id: check
        run: |
          # If a specific version is provided, always allow publishing
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "Version override provided, allowing publish"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if there are change files with publishable change types (patch, minor, major)
          # Change files with type "none" should not trigger a publish
          PUBLISHABLE_CHANGES=0
          
          # Use find with while loop and process substitution to handle filenames safely
          while IFS= read -r -d '' file; do
            # Use jq to properly parse JSON and check for publishable types
            if jq -e '.changes[]? | select(.type == "patch" or .type == "minor" or .type == "major")' "$file" > /dev/null 2>&1; then
              echo "Found publishable change in: $file"
              PUBLISHABLE_CHANGES=$((PUBLISHABLE_CHANGES + 1))
            fi
          done < <(find common/changes -type f -name "*.json" -print0 2>/dev/null)

          if [[ $PUBLISHABLE_CHANGES -gt 0 ]]; then
            echo "Found $PUBLISHABLE_CHANGES change file(s) with publishable types"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No publishable change files found. Run 'rush change' to create change files before releasing."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  # Run e2e tests before publishing
  e2e-tests:
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'
    uses: ./.github/workflows/wf_test-e2e.yml

  publish:
    needs: [check-changes, e2e-tests]
    if: needs.check-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: npm-publish
    outputs:
      version: ${{ steps.bump.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Upgrade npm for OIDC support
        # npm 11.5.1+ required for OIDC trusted publishing
        run: npm install -g npm@latest

      - name: Enable corepack
        run: corepack enable

      - name: Install Rush
        run: npm install -g @microsoft/rush

      - name: Install dependencies
        run: rush install

      - name: Verify change files
        if: ${{ github.event.inputs.version == '' }}
        run: rush change --verify

      - name: Lint check
        run: rush lint:check

      - name: Build
        run: rush build

      - name: Run unit tests
        run: rush test

      # E2E tests already ran in the e2e-tests job

      - name: Bump versions
        id: bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Use override version if provided, otherwise auto-bump
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "Using override version: ${{ github.event.inputs.version }}"
            rush version --override-version ${{ github.event.inputs.version }}
          else
            # Determine the highest bump type from all change files
            # For lockStepVersion policy, we need to aggregate change types and pass --override-bump
            BUMP_TYPE="patch"  # Default to patch
            
            # Use find with while loop and process substitution to handle filenames safely
            while IFS= read -r -d '' file; do
              # Use jq to properly parse JSON and extract change types
              # Check if any change in the file has type "major" or "minor"
              if jq -e '.changes[]? | select(.type == "major")' "$file" > /dev/null 2>&1; then
                BUMP_TYPE="major"
                break  # Major is highest priority, stop looking
              elif jq -e '.changes[]? | select(.type == "minor")' "$file" > /dev/null 2>&1; then
                BUMP_TYPE="minor"
                # Don't break, keep looking for major
              fi
              # patch changes don't need to update BUMP_TYPE since it's the default
            done < <(find common/changes -type f -name "*.json" -print0 2>/dev/null)
            
            echo "Determined bump type from change files: $BUMP_TYPE"
            rush version --bump --override-bump "$BUMP_TYPE"
          fi

          # Commit version changes if there are any
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .
            git commit --no-verify -m "chore: bump versions [skip ci]"
          fi

          # Extract the new version from the main package
          VERSION=$(node -p "require('./packages/core/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Push version changes
        # Push BEFORE npm publish to ensure git state is saved even if publish fails
        run: git push origin main

      - name: Publish packages
        # OIDC trusted publishing: npm automatically uses GitHub's OIDC token
        # No NPM_TOKEN secret needed - configure trusted publishers on npmjs.com
        # Provenance attestations are automatically generated with trusted publishing
        run: >-
          rush publish --publish --include-all
          --set-access-level public --apply

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          generate_release_notes: true

  # Deploy documentation after successful publish
  deploy-docs:
    needs: publish
    uses: ./.github/workflows/docs-deploy.yml
    with:
      version: ${{ needs.publish.outputs.version }}
