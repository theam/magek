name: Publish to npm

on:
  push:
    branches:
      - main
    # Only trigger on changes to publishable packages or change files
    paths:
      - 'packages/**'
      - 'adapters/**'
      - 'common/changes/**'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Specific version to release (optional, e.g., 1.0.0). If empty, uses automatic bump.'
        required: false
        type: string
      bump_type:
        description: 'Version bump type (only used if version is not specified)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  id-token: write   # Required for OIDC
  contents: write   # Required to push version commits/tags

env:
  CI: true

jobs:
  # Check if there are actual changes that require publishing
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for publishable changes
        id: check
        run: |
          # For workflow_dispatch or release events, always publish
          if [[ "${{ github.event_name }}" != "push" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if there are change files (excluding .gitkeep)
          CHANGE_FILES=$(find common/changes -type f -name "*.json" 2>/dev/null | wc -l)
          if [[ $CHANGE_FILES -gt 0 ]]; then
            echo "Found $CHANGE_FILES change file(s)"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if any source files in publishable packages changed
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- \
            'packages/*/src/**' \
            'packages/*/package.json' \
            'adapters/**/src/**' \
            'adapters/**/package.json' \
            2>/dev/null || echo "")

          if [[ -n "$CHANGED_FILES" ]]; then
            echo "Found changes in publishable packages:"
            echo "$CHANGED_FILES"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No publishable changes found"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  publish:
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: npm-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Upgrade npm for OIDC support
        # npm 11.5.1+ required for OIDC trusted publishing
        run: npm install -g npm@latest

      - name: Enable corepack
        run: corepack enable

      - name: Install Rush
        run: npm install -g @microsoft/rush

      - name: Install dependencies
        run: rush install

      - name: Build
        run: rush build

      - name: Run tests
        run: rush test

      - name: Bump versions
        id: bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Use override version if provided, otherwise auto-bump
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "Using override version: ${{ github.event.inputs.version }}"
            rush version --override-version ${{ github.event.inputs.version }}
          else
            rush version --bump
          fi

          # Commit version changes if there are any
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .
            git commit --no-verify -m "chore: bump versions [skip ci]"
          fi

          # Extract the new version from the main package
          VERSION=$(node -p "require('./packages/core/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Publish packages
        # OIDC trusted publishing: npm automatically uses GitHub's OIDC token
        # No NPM_TOKEN secret needed - configure trusted publishers on npmjs.com
        # Provenance attestations are automatically generated with trusted publishing
        run: >-
          rush publish --publish --include-all
          --set-access-level public --apply

      - name: Push version changes and tags
        run: |
          git push origin main --follow-tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          generate_release_notes: true
