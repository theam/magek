name: Deploy Documentation to GitHub Pages

on:
  # Called from publish workflow after successful release
  workflow_call:
    inputs:
      version:
        description: 'Version to deploy (e.g., "0.0.7")'
        required: true
        type: string
  # Manual trigger for testing or emergency fixes
  workflow_dispatch:
    inputs:
      version:
        description: 'Version label for docs (e.g., "dev" for development preview, or "0.0.7" for specific version)'
        required: false
        default: 'dev'
        type: string

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Update dependencies
        run: node common/scripts/install-run-rush.js update

      - name: Install dependencies
        run: node common/scripts/install-run-rush.js install

      - name: Build packages
        run: node common/scripts/install-run-rush.js build

      - name: Build documentation
        run: |
          VERSION=${{ inputs.version }}
          echo "Building complete docs site for version $VERSION"
          node scripts/build-docs.js $VERSION

      - name: Checkout gh-pages branch
        uses: actions/checkout@v6
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Create gh-pages branch if it doesn't exist
        run: |
          if [ ! -d "gh-pages/.git" ]; then
            echo "gh-pages branch doesn't exist, creating it..."
            mkdir -p gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit --allow-empty -m "Initial gh-pages branch"
            git remote add origin https://github.com/${{ github.repository }}.git
          fi

      - name: Update gh-pages with new version
        run: |
          VERSION=${{ inputs.version }}

          # Remove existing version directory to prevent stale files on re-runs
          rm -rf "gh-pages/v${VERSION}"

          # Copy entire built site (new files added, existing replaced, old versions untouched)
          cp -r common/temp/docs-site/* gh-pages/

          # Update versions.json manifest
          node scripts/update-versions-manifest.js gh-pages/versions.json $VERSION

      - name: Commit and push to gh-pages
        run: |
          VERSION=${{ inputs.version }}
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          # Dynamic commit message based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            COMMIT_MSG="docs: deploy v${VERSION} documentation (manual)"
          else
            COMMIT_MSG="docs: deploy v${VERSION} documentation"
          fi

          git diff --staged --quiet || git commit -m "$COMMIT_MSG"
          git push origin gh-pages
