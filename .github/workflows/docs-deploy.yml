name: Deploy Documentation to GitHub Pages

on:
  # Documentation is now deployed as part of the publish workflow
  # This workflow can be used for manual testing or emergency fixes
  workflow_dispatch:
    inputs:
      version:
        description: 'Version label for docs (e.g., "dev" for development preview, or "0.0.7" for specific version)'
        required: false
        default: 'dev'
        type: string

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Update dependencies
        run: node common/scripts/install-run-rush.js update

      - name: Install dependencies
        run: node common/scripts/install-run-rush.js install

      - name: Build packages
        run: node common/scripts/install-run-rush.js build

      - name: Build landing page
        run: |
          VERSION=${{ github.event.inputs.version }}
          echo "Building landing page with documentation link to v${VERSION}"
          npm install marked
          node scripts/build-landing-page.js $VERSION

      - name: Build documentation
        run: |
          VERSION=${{ github.event.inputs.version }}
          echo "Building documentation for version $VERSION"

          # Build documentation
          node common/scripts/install-run-rush.js docs:build

          # Move built docs to versioned folder
          mkdir -p common/temp/versioned-docs/v${VERSION}
          mv common/temp/docs-site/* common/temp/versioned-docs/v${VERSION}/

      - name: Checkout gh-pages branch
        uses: actions/checkout@v6
        with:
          ref: gh-pages
          path: gh-pages

      - name: Update gh-pages with new version
        run: |
          VERSION=${{ github.event.inputs.version }}

          # Copy landing page to root
          cp common/temp/landing-page/index.html gh-pages/index.html

          # Copy new version folder (overwrites if exists)
          rm -rf gh-pages/v${VERSION}
          cp -r common/temp/versioned-docs/v${VERSION} gh-pages/v${VERSION}

          # Update versions.json manifest
          node scripts/update-versions-manifest.js gh-pages/versions.json $VERSION

      - name: Commit and push to gh-pages
        run: |
          VERSION=${{ github.event.inputs.version }}
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          # Use --allow-empty in case there are no changes
          git diff --staged --quiet || git commit -m "docs: deploy v${VERSION} documentation (manual)"
          git push origin gh-pages
