<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Events | Magek Framework</title><meta name="description" content="Documentation for Magek Framework"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><link rel="stylesheet" href="../assets/custom.css"/><script defer src="../assets/main.js"></script><script defer src="../assets/custom.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">Magek Framework</a><div id="tsd-toolbar-links"><a href="https://github.com/theam/magek">GitHub</a><a href="https://magek.ai">Website</a></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="Documentation.html">Documentation</a></li><li><a href="" aria-current="page">Events</a></li></ul></div><div class="tsd-panel tsd-typography"><h1 id="event" class="tsd-anchor-link">Event<a href="#event" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>An event is a fact of something that has happened in your application. Every action that takes place on your application should be stored as an event. They are stored in a single collection, forming a set of <strong>immutable records of facts</strong> that contain the whole story of your application. This collection of events is commonly known as the <strong>Event Store</strong>.</p>
<h2 id="creating-an-event" class="tsd-anchor-link">Creating an event<a href="#creating-an-event" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Magek CLI will help you to create new events. You just need to run the following command and the CLI will generate all the boilerplate for you:</p>
<pre><code class="bash"><span class="hl-0">npx</span><span class="hl-1"> </span><span class="hl-2">magek</span><span class="hl-1"> </span><span class="hl-2">new:event</span><span class="hl-1"> </span><span class="hl-2">StockMoved</span><span class="hl-1"> </span><span class="hl-3">--fields</span><span class="hl-1"> </span><span class="hl-2">productID:string</span><span class="hl-1"> </span><span class="hl-2">origin:string</span><span class="hl-1"> </span><span class="hl-2">destination:string</span><span class="hl-1"> </span><span class="hl-2">quantity:number</span>
</code><button type="button">Copy</button></pre>

<p>This will generate a new file called <code>stock-moved.ts</code> in the <code>src/events</code> directory. You can also create the file manually, but you will need to create the class and decorate it, so we recommend using the CLI.</p>
<h2 id="declaring-an-event" class="tsd-anchor-link">Declaring an event<a href="#declaring-an-event" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Events are the cornerstone of Magek because of its event-driven and event-sourced nature. Magek events are TypeScript classes decorated with <code>@Event</code>. An event class may look like this:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-4">Event</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">EventName</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">field1</span><span class="hl-1">!: </span><span class="hl-7">SomeType</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">field2</span><span class="hl-1">!: </span><span class="hl-7">SomeOtherType</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">constructor</span><span class="hl-1">(</span><span class="hl-4">field1</span><span class="hl-1">: </span><span class="hl-7">SomeType</span><span class="hl-1">, </span><span class="hl-4">field2</span><span class="hl-1">: </span><span class="hl-7">SomeOtherType</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-4">field1</span><span class="hl-1"> = </span><span class="hl-4">field1</span><br/><span class="hl-1">    </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-4">field2</span><span class="hl-1"> = </span><span class="hl-4">field2</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-0">entityID</span><span class="hl-1">(): </span><span class="hl-7">UUID</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-5">/* the associated entity ID */</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The class name is the name of the event. The event name is used to identify the event in the application. It is also used to generate the GraphQL schema. The class parameter names are the names of the fields of the event and their types are the types of the fields of the event.</p>
<h2 id="events-and-entities" class="tsd-anchor-link">Events and entities<a href="#events-and-entities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Events and <a href="Documentation.Entities.html">Entities</a> are closely related. Each event will be aggregated (or <em>reduced</em>) into an entity. Therefore, Magek needs a way to know which entity is associated with each event. For that reason, it is required to provide an entity ID with each event. You can declare it with a class function named <code>entityID</code>. For example:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-4">Event</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CartPaid</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">cartID</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">paymentID</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">constructor</span><span class="hl-1">(</span><span class="hl-4">cartID</span><span class="hl-1">: </span><span class="hl-7">UUID</span><span class="hl-1">, </span><span class="hl-4">paymentID</span><span class="hl-1">: </span><span class="hl-7">UUID</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-4">cartID</span><span class="hl-1"> = </span><span class="hl-4">cartID</span><br/><span class="hl-1">    </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-4">paymentID</span><span class="hl-1"> = </span><span class="hl-4">paymentID</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-5">// highlight-start</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-0">entityID</span><span class="hl-1">(): </span><span class="hl-7">UUID</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// returns cartID because we want to associate it with</span><br/><span class="hl-1">    </span><span class="hl-5">// (and reduce it within) the Cart entity</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-4">cartID</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-5">// highlight-end</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Tip:</strong> If your domain requires a <strong><em>Singleton</em></strong> entity, where there's only one instance of that entity in your whole application, you can return a constant value.</p>
</blockquote>
<blockquote>
<p><strong>Caution:</strong> Make sure that the <code>entityID</code> method always returns the same value for the same event's instance. Otherwise, the result of the entity reduction will be unpredictable.</p>
</blockquote>
<h2 id="registering-events-in-the-event-store" class="tsd-anchor-link">Registering events in the event store<a href="#registering-events-in-the-event-store" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>We have shown you how to <em>declare</em> an event in Magek, but we haven't explained how to store them in the event store. In Magek terminology, creating an instance of an event and storing in the event store is known as <code>registering</code> it. You can do that on Magek using the <code>register.events(...)</code> function. The <code>register</code> object is provided as a parameter in the <code>handle</code> method of both <a href="Documentation.Commands.html#registering-events">commands</a> and the <a href="Documentation.Event_Handlers.html#registering-events-from-an-event-handler">event handlers</a>. For example:</p>
<h3 id="registering-events-from-command-handlers" class="tsd-anchor-link">Registering events from command handlers<a href="#registering-events-from-command-handlers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> [</span><span class="hl-4">Admin</span><span class="hl-1">],</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">MoveStock</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">productID</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">origin</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">destination</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">: </span><span class="hl-7">MoveStock</span><span class="hl-1">, </span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-7">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-0">enoughStock</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-4">origin</span><span class="hl-1">, </span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-4">quantity</span><span class="hl-1">, </span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-4">productID</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">      </span><span class="hl-4">register</span><span class="hl-1">.</span><span class="hl-0">events</span><span class="hl-1">(</span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ErrorEvent</span><span class="hl-1">(</span><span class="hl-2">`There is not enough stock for </span><span class="hl-3">${</span><span class="hl-4">command</span><span class="hl-11">.</span><span class="hl-4">productID</span><span class="hl-3">}</span><span class="hl-2"> at </span><span class="hl-3">${</span><span class="hl-4">command</span><span class="hl-11">.</span><span class="hl-4">origin</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">))</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="registering-events-from-event-handlers" class="tsd-anchor-link">Registering events from event handlers<a href="#registering-events-from-event-handlers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">EventHandler</span><span class="hl-1">(</span><span class="hl-4">StockMoved</span><span class="hl-1">)</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">HandleAvailability</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">: </span><span class="hl-7">StockMoved</span><span class="hl-1">, </span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-7">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">      </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">      </span><span class="hl-4">register</span><span class="hl-1">.</span><span class="hl-0">events</span><span class="hl-1">(</span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ProductAvailabilityChanged</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">productID</span><span class="hl-1">, </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">quantity</span><span class="hl-1">))</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="events-naming-convention" class="tsd-anchor-link">Events naming convention<a href="#events-naming-convention" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>As with commands, you can name events in any way you want, depending on your application's domain. However, we recommend you to choose short sentences written in past tense because events are facts that have happened and can't be changed. Some event names would be:</p>
<ul>
<li>ProductCreated</li>
<li>ProductUpdated</li>
<li>ProductDeleted</li>
<li>CartItemChanged</li>
<li>StockMoved</li>
</ul>
<p>As with other Magek files, events have their own directory:</p>
<pre><code class="text">&lt;project-root&gt;
├── src
│   ├── commands
│   ├── common
│   ├── config
│   ├── entities
│   ├── events &lt;------ put them here
│   ├── index.ts
│   └── read-models
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#event"><span>Event</span></a><ul><li><a href="#creating-an-event"><span>Creating an event</span></a></li><li><a href="#declaring-an-event"><span>Declaring an event</span></a></li><li><a href="#events-and-entities"><span>Events and entities</span></a></li><li><a href="#registering-events-in-the-event-store"><span>Registering events in the event store</span></a></li><li><ul><li><a href="#registering-events-from-command-handlers"><span>Registering events from command handlers</span></a></li><li><a href="#registering-events-from-event-handlers"><span>Registering events from event handlers</span></a></li></ul></li><li><a href="#events-naming-convention"><span>Events naming convention</span></a></li></ul></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/theam/magek" class="tsd-nav-link">GitHub</a><a href="https://magek.ai" class="tsd-nav-link">Website</a></nav><nav class="tsd-navigation"><a href="../index.html">Magek Framework</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
