<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Commands | Magek Framework</title><meta name="description" content="Documentation for Magek Framework"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><link rel="stylesheet" href="../assets/custom.css"/><script defer src="../assets/main.js"></script><script defer src="../assets/custom.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">Magek Framework</a><div id="tsd-toolbar-links"><a href="https://github.com/theam/magek">GitHub</a><a href="https://magek.ai">Website</a></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="Documentation.html">Documentation</a></li><li><a href="" aria-current="page">Commands</a></li></ul></div><div class="tsd-panel tsd-typography"><h1 id="command" class="tsd-anchor-link">Command<a href="#command" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Commands are any action a user performs on your application. For example, <code>RemoveItemFromCart</code>, <code>RatePhoto</code> or <code>AddCommentToPost</code>. They express the intention of an user, and they are the main interaction mechanism of your application. They are a similar to the concept of a <strong>request on a REST API</strong>. Command issuers can also send data on a command as parameters.</p>
<h2 id="creating-a-command" class="tsd-anchor-link">Creating a command<a href="#creating-a-command" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Magek CLI will help you to create new commands. You just need to run the following command and the CLI will generate all the boilerplate for you:</p>
<pre><code class="bash"><span class="hl-0">npx</span><span class="hl-1"> </span><span class="hl-2">magek</span><span class="hl-1"> </span><span class="hl-2">new:command</span><span class="hl-1"> </span><span class="hl-2">CreateProduct</span><span class="hl-1"> </span><span class="hl-3">--fields</span><span class="hl-1"> </span><span class="hl-2">sku:SKU</span><span class="hl-1"> </span><span class="hl-2">displayName:string</span><span class="hl-1"> </span><span class="hl-2">description:string</span><span class="hl-1"> </span><span class="hl-2">price:Money</span>
</code><button type="button">Copy</button></pre>

<p>This will generate a new file called <code>create-product</code> in the <code>src/commands</code> directory. You can also create the file manually, but you will need to create the class and decorate it, so we recommend using the CLI.</p>
<h2 id="declaring-a-command" class="tsd-anchor-link">Declaring a command<a href="#declaring-a-command" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>In Magek you define them as TypeScript classes decorated with the <code>@Command</code> decorator. The <code>Command</code> parameters will be declared as properties of the class.</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CommandName</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">fieldA</span><span class="hl-1">!: </span><span class="hl-7">SomeType</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">fieldB</span><span class="hl-1">!: </span><span class="hl-7">SomeOtherType</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>These commands are handled by <code>Command Handlers</code>, the same way a <strong>REST Controller</strong> do with a request. To create a <code>Command handler</code> of a specific Command, you must declare a <code>handle</code> class function inside the corresponding command you want to handle. For example:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CommandName</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">fieldA</span><span class="hl-1">!: </span><span class="hl-7">SomeType</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">fieldB</span><span class="hl-1">!: </span><span class="hl-7">SomeOtherType</span><br/><br/><span class="hl-1">  </span><span class="hl-5">// highlight-start</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">: </span><span class="hl-7">CommandName</span><span class="hl-1">, </span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-7">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-5">// Validate inputs</span><br/><span class="hl-1">    </span><span class="hl-5">// Run domain logic</span><br/><span class="hl-1">    </span><span class="hl-5">// register.events([event1,...])</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-5">// highlight-end</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Magek will then generate the GraphQL mutation for the corresponding command, and the infrastructure to handle them. You only have to define the class and the handler function. Commands are part of the public API, so you can define authorization policies for them, you can read more about this on <a href="/security/authorization">the authorization section</a>.</p>
<blockquote>
<p><strong>Tip:</strong> We recommend using command handlers to validate input data before registering events into the event store because they are immutable once there.</p>
</blockquote>
<h2 id="the-command-handler-function" class="tsd-anchor-link">The command handler function<a href="#the-command-handler-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Each command class must have a method called <code>handle</code>. This function is the command handler, and it will be called by the framework every time one instance of this command is submitted. Inside the handler you can run validations, return errors, query entities to make decisions, and register relevant domain events.</p>
<h3 id="registering-events" class="tsd-anchor-link">Registering events<a href="#registering-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Within the command handler execution, it is possible to register domain events. The command handler function receives the <code>register</code> argument, so within the handler, it is possible to call <code>register.events(...)</code> with a list of events.</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CreateProduct</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">sku</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">: </span><span class="hl-7">CreateProduct</span><span class="hl-1">, </span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-7">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">string</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">    </span><span class="hl-4">register</span><span class="hl-1">.</span><span class="hl-0">event</span><span class="hl-1">(</span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ProductCreated</span><span class="hl-1">(</span><span class="hl-5">/*...*/</span><span class="hl-1">))</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>For more details about events and the register parameter, see the <a href="/architecture/event"><code>Events</code></a> section.</p>
<h3 id="returning-a-value" class="tsd-anchor-link">Returning a value<a href="#returning-a-value" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The command handler function can return a value. This value will be the response of the GraphQL mutation. By default, the command handler function expects you to return a <code>void</code> as a return type. Since GrahpQL does not have a <code>void</code> type, the command handler function returns <code>true</code> when called through the GraphQL. This is because the GraphQL specification requires a response, and <code>true</code> is the most appropriate value to represent a successful execution with no return value.</p>
<p>If you want to return a value, you can change the return type of the handler function. For example, if you want to return a <code>string</code>:</p>
<p>For example:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CreateProduct</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">sku</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">: </span><span class="hl-7">CreateProduct</span><span class="hl-1">, </span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-7">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">string</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-4">register</span><span class="hl-1">.</span><span class="hl-0">event</span><span class="hl-1">(</span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ProductCreated</span><span class="hl-1">(</span><span class="hl-5">/*...*/</span><span class="hl-1">))</span><br/><span class="hl-1">    </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-2">&#39;Product created!&#39;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="validating-data" class="tsd-anchor-link">Validating data<a href="#validating-data" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><blockquote>
<p><strong>Tip:</strong> Magek uses the typed nature of GraphQL to ensure that types are correct before reaching the handler, so <strong>you don't have to validate types</strong>.</p>
</blockquote>
<h4 id="throw-an-error" class="tsd-anchor-link">Throw an error<a href="#throw-an-error" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>A command will fail if there is an uncaught error during its handling. When a command fails, Magek will return a detailed error response with the message of the thrown error. This is useful for debugging, but it is also a security feature. Magek will never return an error stack trace to the client, so you don't have to worry about exposing internal implementation details.</p>
<p>One case where you might want to throw an error is when the command is invalid because it breaks a business rule. For example, if the command contains a negative price. In that case, you can throw an error in the handler. Magek will use the error's message as the response to make it descriptive. For example, given this command:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CreateProduct</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">sku</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">: </span><span class="hl-7">CreateProduct</span><span class="hl-1">, </span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-7">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">priceLimit</span><span class="hl-1"> = </span><span class="hl-9">10</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-4">price</span><span class="hl-1"> &gt;= </span><span class="hl-4">priceLimit</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">      </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`price must be below </span><span class="hl-3">${</span><span class="hl-4">priceLimit</span><span class="hl-3">}</span><span class="hl-2">, and it was </span><span class="hl-3">${</span><span class="hl-4">command</span><span class="hl-11">.</span><span class="hl-4">price</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">)</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>You'll get something like this response:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;errors&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-10">&quot;message&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;price must be below 10, and it was 19.99&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-10">&quot;path&quot;</span><span class="hl-1">: [</span><span class="hl-2">&quot;CreateProduct&quot;</span><span class="hl-1">]</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  ]</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h4 id="register-error-events" class="tsd-anchor-link">Register error events<a href="#register-error-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>There could be situations in which you want to register an event representing an error. For example, when moving items with insufficient stock from one location to another:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">MoveStock</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">productID</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">origin</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">destination</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">: </span><span class="hl-7">MoveStock</span><span class="hl-1">, </span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-7">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-0">enoughStock</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-4">productID</span><span class="hl-1">, </span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-4">origin</span><span class="hl-1">, </span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-4">quantity</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">      </span><span class="hl-4">register</span><span class="hl-1">.</span><span class="hl-0">events</span><span class="hl-1">(</span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ErrorEvent</span><span class="hl-1">(</span><span class="hl-2">`There is not enough stock for </span><span class="hl-3">${</span><span class="hl-4">command</span><span class="hl-11">.</span><span class="hl-4">productID</span><span class="hl-3">}</span><span class="hl-2"> at </span><span class="hl-3">${</span><span class="hl-4">command</span><span class="hl-11">.</span><span class="hl-4">origin</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">))</span><br/><span class="hl-1">    } </span><span class="hl-6">else</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">register</span><span class="hl-1">.</span><span class="hl-0">events</span><span class="hl-1">(</span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">StockMoved</span><span class="hl-1">(</span><span class="hl-5">/*...*/</span><span class="hl-1">))</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-3">private</span><span class="hl-1"> </span><span class="hl-0">enoughStock</span><span class="hl-1">(</span><span class="hl-4">productID</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">, </span><span class="hl-4">origin</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">: </span><span class="hl-7">number</span><span class="hl-1">): </span><span class="hl-7">boolean</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">/* ... */</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>In this case, the command operation can still be completed. An event handler will take care of that `ErrorEvent and proceed accordingly.</p>
<h3 id="reading-entities" class="tsd-anchor-link">Reading entities<a href="#reading-entities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Event handlers are a good place to make decisions and, to make better decisions, you need information. The <code>Magek.entity</code> function allows you to inspect the application state. This function receives two arguments, the <code>Entity</code>'s name to fetch and the <code>entityID</code>. Here is an example of fetching an entity called <code>Stock</code>:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">MoveStock</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">productID</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">origin</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">destination</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">: </span><span class="hl-7">MoveStock</span><span class="hl-1">, </span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-7">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">stock</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">Magek</span><span class="hl-1">.</span><span class="hl-0">entity</span><span class="hl-1">(</span><span class="hl-4">Stock</span><span class="hl-1">, </span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-4">productID</span><span class="hl-1">)</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-0">enoughStock</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-4">origin</span><span class="hl-1">, </span><span class="hl-4">command</span><span class="hl-1">.</span><span class="hl-4">quantity</span><span class="hl-1">, </span><span class="hl-4">stock</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-4">register</span><span class="hl-1">.</span><span class="hl-0">events</span><span class="hl-1">(</span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ErrorEvent</span><span class="hl-1">(</span><span class="hl-2">`There is not enough stock for </span><span class="hl-3">${</span><span class="hl-4">command</span><span class="hl-11">.</span><span class="hl-4">productID</span><span class="hl-3">}</span><span class="hl-2"> at </span><span class="hl-3">${</span><span class="hl-4">command</span><span class="hl-11">.</span><span class="hl-4">origin</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">))</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-3">private</span><span class="hl-1"> </span><span class="hl-0">enoughStock</span><span class="hl-1">(</span><span class="hl-4">origin</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">: </span><span class="hl-7">number</span><span class="hl-1">, </span><span class="hl-4">stock</span><span class="hl-1">?: </span><span class="hl-7">Stock</span><span class="hl-1">): </span><span class="hl-7">boolean</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">count</span><span class="hl-1"> = </span><span class="hl-4">stock</span><span class="hl-1">?.</span><span class="hl-4">countByLocation</span><span class="hl-1">[</span><span class="hl-4">origin</span><span class="hl-1">]</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> !!</span><span class="hl-4">count</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">count</span><span class="hl-1"> &gt;= </span><span class="hl-4">quantity</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="authorizing-a-command" class="tsd-anchor-link">Authorizing a command<a href="#authorizing-a-command" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Commands are part of the public API of a Magek application, so you can define who is authorized to submit them. All commands are protected by default, which means that no one can submit them. In order to allow users to submit a command, you must explicitly authorize them. You can use the <code>authorize</code> field of the <code>@Command</code> decorator to specify the authorization rule.</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CreateProduct</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">sku</span><span class="hl-1">!: </span><span class="hl-7">Sku</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">displayName</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">description</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">: </span><span class="hl-7">CreateProduct</span><span class="hl-1">, </span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-7">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-4">register</span><span class="hl-1">.</span><span class="hl-0">events</span><span class="hl-1">(</span><span class="hl-5">/* YOUR EVENT HERE */</span><span class="hl-1">)</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>You can read more about this on the <a href="/security/authorization">Authorization section</a>.</p>
<h2 id="submitting-a-command" class="tsd-anchor-link">Submitting a command<a href="#submitting-a-command" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Magek commands are accessible to the outside world as GraphQL mutations. GrahpQL fits very well with Magek's CQRS approach because it has two kinds of operations: Mutations and Queries. Mutations are actions that modify the server-side data, just like commands.</p>
<p>Magek automatically creates one mutation per command. The framework infers the mutation input type from the command fields. Given this <code>CreateProduct</code> command:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CreateProduct</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">sku</span><span class="hl-1">!: </span><span class="hl-7">Sku</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">displayName</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">description</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">command</span><span class="hl-1">: </span><span class="hl-7">CreateProduct</span><span class="hl-1">, </span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-7">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-4">register</span><span class="hl-1">.</span><span class="hl-0">events</span><span class="hl-1">(</span><span class="hl-5">/* YOUR EVENT HERE */</span><span class="hl-1">)</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Magek generates the following GraphQL mutation:</p>
<pre><code class="graphql"><span class="hl-3">mutation</span><span class="hl-1"> </span><span class="hl-0">CreateProduct</span><span class="hl-1">(</span><span class="hl-4">$input</span><span class="hl-1">: </span><span class="hl-7">CreateProductInput</span><span class="hl-1">!): </span><span class="hl-0">Boolean</span>
</code><button type="button">Copy</button></pre>

<p>where the schema for <code>CreateProductInput</code> is</p>
<pre><code class="text">{
  sku: String
  displayName: String
  description: String
  price: Float
}
</code><button type="button">Copy</button></pre>

<h2 id="commands-naming-convention" class="tsd-anchor-link">Commands naming convention<a href="#commands-naming-convention" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Semantics are very important in Magek as it will play an essential role in designing a coherent system. Your application should reflect your domain concepts, and commands are not an exception. Although you can name commands in any way you want, we strongly recommend you to <strong>name them starting with verbs in imperative plus the object being affected</strong>. If we were designing an e-commerce application, some commands would be:</p>
<ul>
<li>CreateProduct</li>
<li>DeleteProduct</li>
<li>UpdateProduct</li>
<li>ChangeCartItems</li>
<li>ConfirmPayment</li>
<li>MoveStock</li>
<li>UpdateCartShippingAddress</li>
</ul>
<p>Despite you can place commands, and other Magek files, in any directory, we strongly recommend you to put them in <code>&lt;project-root&gt;/src/commands</code>. Having all the commands in one place will help you to understand your application's capabilities at a glance.</p>
<pre><code class="text">&lt;project-root&gt;
├── src
│   ├── commands &lt;------ put them here
│   ├── common
│   ├── config
│   ├── entities
│   ├── events
│   ├── index.ts
│   └── read-models
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#command"><span>Command</span></a><ul><li><a href="#creating-a-command"><span>Creating a command</span></a></li><li><a href="#declaring-a-command"><span>Declaring a command</span></a></li><li><a href="#the-command-handler-function"><span>The command handler function</span></a></li><li><ul><li><a href="#registering-events"><span>Registering events</span></a></li><li><a href="#returning-a-value"><span>Returning a value</span></a></li><li><a href="#validating-data"><span>Validating data</span></a></li><li><ul><li><a href="#throw-an-error"><span>Throw an error</span></a></li><li><a href="#register-error-events"><span>Register error events</span></a></li></ul></li><li><a href="#reading-entities"><span>Reading entities</span></a></li></ul></li><li><a href="#authorizing-a-command"><span>Authorizing a command</span></a></li><li><a href="#submitting-a-command"><span>Submitting a command</span></a></li><li><a href="#commands-naming-convention"><span>Commands naming convention</span></a></li></ul></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/theam/magek" class="tsd-nav-link">GitHub</a><a href="https://magek.ai" class="tsd-nav-link">Website</a></nav><nav class="tsd-navigation"><a href="../index.html">Magek Framework</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
