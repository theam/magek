<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Read Models | Magek Framework</title><meta name="description" content="Documentation for Magek Framework"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><link rel="stylesheet" href="../assets/custom.css"/><script defer src="../assets/main.js"></script><script defer src="../assets/custom.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">Magek Framework</a><div id="tsd-toolbar-links"><a href="https://github.com/theam/magek">GitHub</a></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="Documentation.html">Documentation</a></li><li><a href="" aria-current="page">Read Models</a></li></ul></div><div class="tsd-panel tsd-typography"><h1 id="read-model" class="tsd-anchor-link">Read model<a href="#read-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>A read model contains the data of your application that is exposed to the client through the GraphQL API. It's a <em>projection</em> of one or more entities, so you dont have to directly expose them to the client. Magek generates the GraphQL queries that allow you to fetch your read models.</p>
<p>In other words, Read Models are cached data optimized for read operations. They're updated reactively when <a href="Documentation.Entities.html">Entities</a> are updated after reducing <a href="Documentation.Events.html">events</a>.</p>
<h2 id="creating-a-read-model" class="tsd-anchor-link">Creating a read model<a href="#creating-a-read-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Magek CLI will help you to create new read models. You just need to run the following command and the CLI will generate all the boilerplate for you:</p>
<pre><code class="shell"><span class="hl-0">npx</span><span class="hl-1"> </span><span class="hl-2">magek</span><span class="hl-1"> </span><span class="hl-2">new:read-model</span><span class="hl-1"> </span><span class="hl-2">CartReadModel</span><span class="hl-1"> </span><span class="hl-3">--fields</span><span class="hl-1"> </span><span class="hl-2">id:UUID</span><span class="hl-1"> </span><span class="hl-2">cartItems:&quot;Array&lt;CartItem&gt;&quot;</span><span class="hl-1"> </span><span class="hl-2">paid:boolean</span><span class="hl-1"> </span><span class="hl-3">--projects</span><span class="hl-1"> </span><span class="hl-2">Cart</span>
</code><button type="button">Copy</button></pre>

<p>This will generate a new file called <code>cart-read-model.ts</code> in the <code>src/read-models</code> directory. You can also create the file manually, but you will need to create the class and decorate it, so we recommend using the CLI.</p>
<h2 id="declaring-a-read-model" class="tsd-anchor-link">Declaring a read model<a href="#declaring-a-read-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>In Magek, a read model is a class decorated with the <code>@ReadModel</code> decorator. The properties of the class are the fields of the read model. The following example shows a read model with two fields:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">ReadModelName</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">fieldA</span><span class="hl-1">!: </span><span class="hl-7">SomeType</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">fieldB</span><span class="hl-1">!: </span><span class="hl-7">SomeType</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Info:</strong> The <code>ReadModelName</code> class name will be used as the read model name in the GraphQL schema. Also, the types on the constructor will be used to generate the GraphQL schema. For example, if you have a property of type <code>Array&lt;CartItem&gt;</code> the GraphQL schema will know that is an array of <code>CartItem</code> objects.</p>
</blockquote>
<h2 id="the-projection-function" class="tsd-anchor-link">The projection function<a href="#the-projection-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The projection function is a static method decorated with the <code>@Projects</code> decorator. It is used to define how the read model is updated when an entity is modified. he projection function must return a new instance of the read model, it receives two arguments:</p>
<ul>
<li><code>entity</code>: The entity that has been modified</li>
<li><code>current?</code>: The current read model instance. If it's the first time the read model is created, this argument will be <code>undefined</code></li>
</ul>
<p>You must provide the <code>@Projects</code> decorator with an entity class and the <strong><em>join key</em></strong>. The join key is the name of the field in the entity that is used to match it with the read model's <code>id</code> field. In the example below, we are using the <code>id</code> field of the <code>Cart</code> entity to match it with the <code>CartReadModel</code> read model.</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CartReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">cartItems</span><span class="hl-1">!: </span><span class="hl-7">Array</span><span class="hl-1">&lt;</span><span class="hl-7">CartItem</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">paid</span><span class="hl-1">!: </span><span class="hl-7">boolean</span><br/><br/><span class="hl-1">  </span><span class="hl-5">// highlight-start</span><br/><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">Cart</span><span class="hl-1">, </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-0">projectCart</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-7">Cart</span><span class="hl-1">, </span><span class="hl-4">currentCartReadModel</span><span class="hl-1">?: </span><span class="hl-7">CartReadModel</span><span class="hl-1">): </span><span class="hl-7">CartReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-0">evolve</span><span class="hl-1">(</span><span class="hl-4">currentCartReadModel</span><span class="hl-1">, {</span><br/><span class="hl-1">      </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">cartItems:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">cartItems</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">paid:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">paid</span><span class="hl-1">,</span><br/><span class="hl-1">    })</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-5">// highlight-end</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="projecting-multiple-entities" class="tsd-anchor-link">Projecting multiple entities<a href="#projecting-multiple-entities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>You are able to project multiple entities into the same read model. For example, you can have a <code>UserReadModel</code> that projects both the <code>User</code> entity and the <code>Post</code> entity. In this case, the join key will be different for each entity:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">UserReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">username</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">User</span><span class="hl-1">, </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-0">projectUser</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-7">User</span><span class="hl-1">, </span><span class="hl-4">current</span><span class="hl-1">?: </span><span class="hl-7">UserReadModel</span><span class="hl-1">): </span><span class="hl-7">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-7">UserReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-5">// Here we update the user fields</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">Post</span><span class="hl-1">, </span><span class="hl-2">&#39;ownerId&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-0">projectUserPost</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-7">Post</span><span class="hl-1">, </span><span class="hl-4">current</span><span class="hl-1">?: </span><span class="hl-7">UserReadModel</span><span class="hl-1">): </span><span class="hl-7">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-7">UserReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-5">//Here we can adapt the read model to show specific user information related with the Post entity</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="advanced-join-keys" class="tsd-anchor-link">Advanced join keys<a href="#advanced-join-keys" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>There might be cases where you need to project an entity into a read model using a more complex join key. For that reason, Magek supports other types of join keys.</p>
<h4 id="array-of-entities" class="tsd-anchor-link">Array of entities<a href="#array-of-entities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>You can use an array of entities as a join key. For example, if you have a <code>Group</code> entity with an array of users in that group (<code>users: Array&lt;UUID&gt;</code>), you can have the following to update each <code>UserReadModel</code> accordingly:</p>
<pre><code class="typescript"><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">Group</span><span class="hl-1">, </span><span class="hl-2">&#39;users&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">static</span><span class="hl-1"> </span><span class="hl-0">projectUserGroup</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-4">Group</span><span class="hl-1">, </span><span class="hl-4">readModelID</span><span class="hl-1">: </span><span class="hl-8">UUID</span><span class="hl-1">, </span><span class="hl-4">current</span><span class="hl-1">?: </span><span class="hl-4">UserReadModel</span><span class="hl-1">): </span><span class="hl-4">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-4">UserReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-5">//Here we can update the read models with group information</span><br/><span class="hl-1">    </span><span class="hl-5">//This logic will be executed for each read model id in the array</span><br/><span class="hl-1">  }</span>
</code><button type="button">Copy</button></pre>

<p>You can even select arrays of UUIDs as <code>joinKey</code>. Magek get each value on the array, find a read model with that id and execute the projection function. The signature of the projection function is a bit different in this case. It receives the <code>readModelID</code> as the second argument, which is the id we are projecting from the array. The third argument is the current read model instance, which will be <code>undefined</code> if it's the first time the read model is created. For example, if we have a <code>Group</code> with an array of users in that group (<code>users: Array&lt;UUID&gt;</code>), we can have the following to update each <code>UserReadModel</code> accordingly:</p>
<pre><code class="typescript"><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">Group</span><span class="hl-1">, </span><span class="hl-2">&#39;users&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">static</span><span class="hl-1"> </span><span class="hl-0">projectUserGroup</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-4">Group</span><span class="hl-1">, </span><span class="hl-4">readModelID</span><span class="hl-1">: </span><span class="hl-8">UUID</span><span class="hl-1">, </span><span class="hl-4">current</span><span class="hl-1">?: </span><span class="hl-4">UserReadModel</span><span class="hl-1">): </span><span class="hl-4">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-4">UserReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-5">//Here we can update the read models with group information</span><br/><span class="hl-1">    </span><span class="hl-5">//This logic will be executed for each read model id in the array</span><br/><span class="hl-1">  }</span>
</code><button type="button">Copy</button></pre>

<h4 id="readmodel-queries" class="tsd-anchor-link">ReadModel queries<a href="#readmodel-queries" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>You can use a read model query as a join key to get all the read models that match the query. For example, consider the following read model for car purchases:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CarPurchasesReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">carModel</span><span class="hl-1">?: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">carOwner</span><span class="hl-1">?: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">offers</span><span class="hl-1">?: </span><span class="hl-7">Array</span><span class="hl-1">&lt;</span><span class="hl-7">CarOffers</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">  </span><span class="hl-5">// rest of the code</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>If a car model changed its name (or any other property of such an entity that's projected in <code>CarPurchasesReadModel</code> changed its value) and there are many purchases associated to that model, then it would be necessary to update all read model instances associated to that specific model so that name change is reflected. The better alternative is to instead project a <code>CarModel</code> entity:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CarPurchasesReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">carModel</span><span class="hl-1">?: </span><span class="hl-7">CarModel</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">carOwner</span><span class="hl-1">?: </span><span class="hl-7">CarOwner</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">offers</span><span class="hl-1">?: </span><span class="hl-7">Array</span><span class="hl-1">&lt;</span><span class="hl-7">CarOffers</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">CarModel</span><span class="hl-1">, (</span><span class="hl-4">carModel</span><span class="hl-1">: </span><span class="hl-7">CarModel</span><span class="hl-1">): </span><span class="hl-7">FilterFor</span><span class="hl-1">&lt;</span><span class="hl-7">CarPurchasesReadModel</span><span class="hl-1">&gt; </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">carModel:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">id:</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-4">eq:</span><span class="hl-1"> </span><span class="hl-4">carModel</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">,</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-0">projectWithModel</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-4">model</span><span class="hl-1">: </span><span class="hl-7">CarModel</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">readModelId</span><span class="hl-1">: </span><span class="hl-7">UUID</span><span class="hl-1"> | </span><span class="hl-7">undefined</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">oldCarPurchaseReadModel</span><span class="hl-1">?: </span><span class="hl-7">CarPurchasesReadModel</span><br/><span class="hl-1">  ): </span><span class="hl-7">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-7">CarPurchasesReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-4">readModelId</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">ReadModelAction</span><span class="hl-1">.</span><span class="hl-4">Nothing</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-0">evolve</span><span class="hl-1">(</span><span class="hl-4">oldCarPurchaseReadModel</span><span class="hl-1">, {</span><br/><span class="hl-1">      </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-4">readModelId</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">carModel:</span><span class="hl-1"> </span><span class="hl-4">model</span><span class="hl-1">,</span><br/><span class="hl-1">    })</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Since the <code>CarModel</code> entity doesn't have a field that matches the <code>id</code> field of <code>CarPurchasesReadModel</code>, this projection can use a read model query join key to get all the <code>CarPurchasesReadModel</code> instances for a given <code>CarModel</code>.</p>
<p>In this case, the <code>projectWithModel</code> function will be called for each <code>CarPurchasesReadModel</code> instance that matches the query. The <code>readModelId</code> argument will be the <code>id</code> of the <code>CarPurchasesReadModel</code> instance.</p>
<p>With this approach, every time there's a change in the <code>CarModel</code> entity it will be reflected in the read model without the need to manually update all read model instances.</p>
<blockquote>
<p><strong>Note:</strong> If no read model matches the query, the <code>projectWithModel</code> function will be called with <code>readModelId</code> set to <code>undefined</code>.</p>
</blockquote>
<blockquote>
<p><strong>Note:</strong> Take a look at the <a href="/graphql#getting-filtering-and-projecting-read-models-data-at-code-level">Getting, filtering and projecting read models data at code level</a> section for more information on how to filter read models.</p>
</blockquote>
<h3 id="returning-special-values" class="tsd-anchor-link">Returning special values<a href="#returning-special-values" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Projections usually return a new instance of the read model. However, there are some special cases where you may want to return a different value.</p>
<h4 id="deleting-read-models" class="tsd-anchor-link">Deleting read models<a href="#deleting-read-models" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>One of the most common cases is when you want to delete a read model. For example, if you have a <code>UserReadModel</code> that projects the <code>User</code> entity, you may want to delete the read model when the user is deleted. In this case you can return the <code>ReadModelAction.Delete</code> value:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">UserReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">username</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">User</span><span class="hl-1">, </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-0">projectUser</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-7">User</span><span class="hl-1">, </span><span class="hl-4">current</span><span class="hl-1">?: </span><span class="hl-7">UserReadModel</span><span class="hl-1">): </span><span class="hl-7">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-7">UserReadModel</span><span class="hl-1">&gt;  {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">deleted</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">ReadModelAction</span><span class="hl-1">.</span><span class="hl-4">Delete</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-0">evolve</span><span class="hl-1">(</span><span class="hl-4">current</span><span class="hl-1">, { </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">username</span><span class="hl-1"> })</span><br/><span class="hl-1">  }</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Info:</strong> Deleting a read model is a very expensive operation. It will trigger a write operation in the read model store. If you can, try to avoid deleting read models.</p>
</blockquote>
<h4 id="keeping-read-models-untouched" class="tsd-anchor-link">Keeping read models untouched<a href="#keeping-read-models-untouched" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Another common case is when you want to keep the read model untouched. For example, if you have a <code>UserReadModel</code> that projects the <code>User</code> entity, you may want to keep the read model untouched there are no releveant changes to your read model. In this case you can return the <code>ReadModelAction.Nothing</code> value:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">UserReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">username</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">User</span><span class="hl-1">, </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-0">projectUser</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-7">User</span><span class="hl-1">, </span><span class="hl-4">current</span><span class="hl-1">?: </span><span class="hl-7">UserReadModel</span><span class="hl-1">): </span><span class="hl-7">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-7">UserReadModel</span><span class="hl-1">&gt;  {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">modified</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-4">ReadModelAction</span><span class="hl-1">.</span><span class="hl-4">Nothing</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-0">evolve</span><span class="hl-1">(</span><span class="hl-4">current</span><span class="hl-1">, { </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">username</span><span class="hl-1"> })</span><br/><span class="hl-1">  }</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Info:</strong> Keeping the read model untouched higly recommended in favour of returning a new instance of the read model with the same data. This will not only prevent a new write operation in the database, making your application more efficient. It will also prevent an unnecessary update to be dispatched to any GrahpQL clients subscribed to that read model.</p>
</blockquote>
<h2 id="nested-queries-and-calculated-values-using-getters" class="tsd-anchor-link">Nested queries and calculated values using getters<a href="#nested-queries-and-calculated-values-using-getters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>You can use TypeScript getters in your read models to allow nested queries and/or return calculated values. You can write arbitrary code in a getter, but you will typically query for related read model objects or generate a value computed based on the current read model instance or context. This greatly improves the potential of customizing your read model responses.</p>
<blockquote>
<p><strong>Info:</strong> Starting version 2.13, getters for values which are calculated using other properties of the read model need to be annotated with the <code>@CalculatedField</code> decorator and a list of those properties as dependencies.</p>
</blockquote>
<p>Here's an example of a getter in the <code>UserReadModel</code> class that returns all <code>PostReadModel</code>s that belong to a specific <code>UserReadModel</code>:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">UserReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">name</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  </span><span class="hl-3">private</span><span class="hl-1"> </span><span class="hl-4">postIds</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><span class="hl-1">[]</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">CalculatedField</span><span class="hl-1">({ </span><span class="hl-4">dependsOn:</span><span class="hl-1"> [</span><span class="hl-2">&#39;postIds&#39;</span><span class="hl-1">] })</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">get</span><span class="hl-1"> </span><span class="hl-0">posts</span><span class="hl-1">(): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">PostReadModel</span><span class="hl-1">[]&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-4">postIds</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">((</span><span class="hl-4">postId</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-4">Magek</span><span class="hl-1">.</span><span class="hl-0">readModel</span><span class="hl-1">(</span><span class="hl-4">PostReadModel</span><span class="hl-1">)</span><br/><span class="hl-1">      .</span><span class="hl-0">filter</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">id:</span><span class="hl-1"> { </span><span class="hl-4">eq:</span><span class="hl-1"> </span><span class="hl-4">postId</span><span class="hl-1"> }</span><br/><span class="hl-1">      })</span><br/><span class="hl-1">      .</span><span class="hl-0">search</span><span class="hl-1">()</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">User</span><span class="hl-1">, </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">static</span><span class="hl-1"> </span><span class="hl-0">projectUser</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-4">User</span><span class="hl-1">, </span><span class="hl-4">current</span><span class="hl-1">?: </span><span class="hl-4">UserReadModel</span><span class="hl-1">): </span><span class="hl-4">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-4">UserReadModel</span><span class="hl-1">&gt;  {</span><br/><span class="hl-1">    return </span><span class="hl-0">evolve</span><span class="hl-1">(</span><span class="hl-4">current</span><span class="hl-1">, { </span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">name</span><span class="hl-1">: </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">name</span><span class="hl-1">, </span><span class="hl-4">postIds</span><span class="hl-1">: </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">postIds</span><span class="hl-1"> })</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>As you can see, the getter posts uses the Magek.readModel(PostReadModel) method and filters it by the ids of the posts saved in the postIds private property. This allows you to retrieve all the PostReadModels that belong to a specific UserReadModel and include them as part of the GraphQL response.</p>
<p>Also, you can see here a simple example of a getter called <code>currentTime</code> that returns the timestamp at the moment of the request:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">get</span><span class="hl-1"> </span><span class="hl-0">currentTime</span><span class="hl-1">(): </span><span class="hl-4">Date</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">()</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>With the getters in place, your GraphQL API will start exposing the getters as regular fields and you will be able to transparently read them as follows:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">user</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-2">&quot;123&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">id</span><br/><span class="hl-1">    </span><span class="hl-4">name</span><br/><span class="hl-1">    </span><span class="hl-4">currentTime</span><br/><span class="hl-1">    </span><span class="hl-4">posts</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">id</span><br/><span class="hl-1">      </span><span class="hl-4">title</span><br/><span class="hl-1">      </span><span class="hl-4">content</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>And here is an example of the corresponding JSON response when this query is executed:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;data&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-10">&quot;user&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">      </span><span class="hl-10">&quot;id&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;123&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-10">&quot;name&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;John Doe&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-10">&quot;currentTime&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;2022-09-20T18:30:00.000Z&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-10">&quot;posts&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">        {</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;id&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;title&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;My first post&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;content&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;This is the content of my first post&quot;</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">        {</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;id&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;2&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;title&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;My second post&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-10">&quot;content&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;This is the content of my second post&quot;</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">      ]</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Notice that getters are not cached in the read models database, so the getters will be executed every time you include these fields in the queries. If access to nested queries is frequent or the size of the responses are big, you could improe your API response performance by querying the read models separately and joining the results in the client application.</p>
<h2 id="authorizing-a-read-model" class="tsd-anchor-link">Authorizing a read model<a href="#authorizing-a-read-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Read models are part of the public API of a Magek application, so you can define who is authorized to submit them. All read models are protected by default, which means that no one can query them. In order to allow users to query a read model, you must explicitly authorize them. You can use the <code>authorize</code> field of the <code>@ReadModel</code> decorator to specify the authorization rule.</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">ProductReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">name</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">description</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">!: </span><span class="hl-7">number</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">Product</span><span class="hl-1">, </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-0">projectProduct</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-7">Product</span><span class="hl-1">, </span><span class="hl-4">current</span><span class="hl-1">?: </span><span class="hl-7">ProductReadModel</span><span class="hl-1">): </span><span class="hl-7">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-7">ProductReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-0">evolve</span><span class="hl-1">(</span><span class="hl-4">current</span><span class="hl-1">, {</span><br/><span class="hl-1">      </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">name:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">name</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">description:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">description</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">price:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">price</span><span class="hl-1">,</span><br/><span class="hl-1">    })</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>You can read more about this on the <a href="/security/authorization">Authorization section</a>.</p>
<h2 id="querying-a-read-model" class="tsd-anchor-link">Querying a read model<a href="#querying-a-read-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Magek read models are accessible to the outside world through GraphQL queries. GrahpQL fits very well with Magek's CQRS approach because it has two kinds of reading operations: Queries and Subscriptions. They are read-only operations that do not modify the state of the application. Magek uses them to fetch data from the read models.</p>
<p>Magek automatically creates the queries and subscriptions for each read model. You can use them to fetch the data from the read models. For example, given the following read model:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CartReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">items</span><span class="hl-1">!: </span><span class="hl-7">Array</span><span class="hl-1">&lt;</span><span class="hl-7">CartItem</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">Cart</span><span class="hl-1">, </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-0">projectCart</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-7">Cart</span><span class="hl-1">, </span><span class="hl-4">currentReadModel</span><span class="hl-1">?: </span><span class="hl-7">CartReadModel</span><span class="hl-1">): </span><span class="hl-7">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-7">CartReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-0">evolve</span><span class="hl-1">(</span><span class="hl-4">currentReadModel</span><span class="hl-1">, { </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">items:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">items</span><span class="hl-1"> })</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>You will get the following GraphQL query and subscriptions:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> </span><span class="hl-0">CartReadModel</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-7">ID</span><span class="hl-1">!): </span><span class="hl-0">CartReadModel</span><br/><span class="hl-0">subscription</span><span class="hl-1"> </span><span class="hl-0">CartReadModel</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-7">ID</span><span class="hl-1">!): </span><span class="hl-0">CartReadModel</span><br/><span class="hl-0">subscription</span><span class="hl-1"> </span><span class="hl-0">CartReadModels</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-7">UUIDPropertyFilter</span><span class="hl-1">!): </span><span class="hl-0">CartReadModel</span>
</code><button type="button">Copy</button></pre>

<p>For more information about queries and how to use them, please check the <a href="/graphql">GraphQL API</a> section.</p>
<h3 id="filtering-a-read-model" class="tsd-anchor-link">Filtering a read model<a href="#filtering-a-read-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Magek GraphQL API provides support for filtering Read Models on <code>queries</code> and <code>subscriptions</code>. To get more information about it go to the <a href="/graphql#filtering-a-read-model">GraphQL API</a> section.</p>
<h2 id="subscribing-to-a-read-model" class="tsd-anchor-link">Subscribing to a read model<a href="#subscribing-to-a-read-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Magek GraphQL API also provides support for real-time updates using subscriptions and a web-socket. To get more information about it go to the <a href="/graphql#subscribing-to-read-models">GraphQL API</a> section.</p>
<h2 id="sorting-read-models" class="tsd-anchor-link">Sorting Read Models<a href="#sorting-read-models" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>There are some cases when it's desirable to query your read models sorted a particular field. An example could be a chat app where you want to fetch the messages of a channel sorted by the time they were sent. Magek provides a special decorator to tag a specific property as a sequence key for a read model:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">MessageReadModel</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><span class="hl-1"> </span><span class="hl-5">// A channel ID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  @</span><span class="hl-4">sequencedBy</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">timestamp</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">contents</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Projects</span><span class="hl-1">(</span><span class="hl-4">Message</span><span class="hl-1">, </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">static</span><span class="hl-1"> </span><span class="hl-0">projectMessage</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-7">Message</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">currentReadModel</span><span class="hl-1">?: </span><span class="hl-7">MessageReadModel</span><br/><span class="hl-1">  ): </span><span class="hl-7">ProjectionResult</span><span class="hl-1">&lt;</span><span class="hl-7">MessageReadModel</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-0">evolve</span><span class="hl-1">(</span><span class="hl-4">currentReadModel</span><span class="hl-1">, {</span><br/><span class="hl-1">      </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">timestamp:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">timestamp</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">contents:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">.</span><span class="hl-4">contents</span><span class="hl-1">,</span><br/><span class="hl-1">    })</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="selecting-fields-from-a-read-model" class="tsd-anchor-link">Selecting fields from a Read Model<a href="#selecting-fields-from-a-read-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>See the <a href="/graphql#getting-filtering-and-projecting-read-models-data-at-code-level"><code>Read Models data at code level</code></a> section for more information about how to select fields from a Read Model.</p>
<h3 id="querying-time-sequences" class="tsd-anchor-link">Querying time sequences<a href="#querying-time-sequences" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Adding a sequence key to a read model changes the behavior of the singular query, which now accepts the sequence key as an optional parameter:</p>
<pre><code class="graphql"><span class="hl-3">query</span><span class="hl-1"> </span><span class="hl-0">MessageReadModel</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-7">ID</span><span class="hl-1">!, </span><span class="hl-4">timestamp</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">): [</span><span class="hl-0">MessageReadModel</span><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>Using this query, when only the id is provided, you get an array of all the messages in the channel sorted by timestamp in ascending order (from older to newer). When you also provide an specific timestamp, you still get an array, but it will only contain the message sent in that exact moment.</p>
<p>It is important to guarantee that the sequence key is unique for each message. Magek uses UUIDv7 (RFC 9562) for all identifiers, which provides time-ordering and lexicographic sortability by design. You can use <code>UUID.generate()</code> to create unique, time-ordered identifiers for your read models. UUIDv7 includes sub-millisecond precision and random bits to ensure uniqueness even for events occurring within the same millisecond.</p>
<p>For more information about queries and how to use them, please check the <a href="/graphql#reading-read-models">GraphQL API</a> section.</p>
<h2 id="read-models-naming-convention" class="tsd-anchor-link">Read models naming convention<a href="#read-models-naming-convention" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>As it has been previously commented, semantics plays an important role in designing a coherent system and your application should reflect your domain concepts, we recommend choosing a representative domain name and use the <code>ReadModel</code> suffix in your read models name.</p>
<p>Despite you can place your read models in any directory, we strongly recommend you to put them in <code>&lt;project-root&gt;/src/read-models</code>. Having all the read models in one place will help you to understand your application's capabilities at a glance.</p>
<pre><code class="text">&lt;project-root&gt;
 src
    commands
    common
    config
    entities
    read-models  &lt;------ put them here
    events
    index.ts
    read-models
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#read-model"><span>Read model</span></a><ul><li><a href="#creating-a-read-model"><span>Creating a read model</span></a></li><li><a href="#declaring-a-read-model"><span>Declaring a read model</span></a></li><li><a href="#the-projection-function"><span>The projection function</span></a></li><li><ul><li><a href="#projecting-multiple-entities"><span>Projecting multiple entities</span></a></li><li><a href="#advanced-join-keys"><span>Advanced join keys</span></a></li><li><ul><li><a href="#array-of-entities"><span>Array of entities</span></a></li><li><a href="#readmodel-queries"><span>Read<wbr/>Model queries</span></a></li></ul></li><li><a href="#returning-special-values"><span>Returning special values</span></a></li><li><ul><li><a href="#deleting-read-models"><span>Deleting read models</span></a></li><li><a href="#keeping-read-models-untouched"><span>Keeping read models untouched</span></a></li></ul></li></ul></li><li><a href="#nested-queries-and-calculated-values-using-getters"><span>Nested queries and calculated values using getters</span></a></li><li><a href="#authorizing-a-read-model"><span>Authorizing a read model</span></a></li><li><a href="#querying-a-read-model"><span>Querying a read model</span></a></li><li><ul><li><a href="#filtering-a-read-model"><span>Filtering a read model</span></a></li></ul></li><li><a href="#subscribing-to-a-read-model"><span>Subscribing to a read model</span></a></li><li><a href="#sorting-read-models"><span>Sorting <wbr/>Read <wbr/>Models</span></a></li><li><a href="#selecting-fields-from-a-read-model"><span>Selecting fields from a <wbr/>Read <wbr/>Model</span></a></li><li><ul><li><a href="#querying-time-sequences"><span>Querying time sequences</span></a></li></ul></li><li><a href="#read-models-naming-convention"><span>Read models naming convention</span></a></li></ul></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/theam/magek" class="tsd-nav-link">GitHub</a></nav><nav class="tsd-navigation"><a href="../index.html">Magek Framework</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
