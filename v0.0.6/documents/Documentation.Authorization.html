<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Authorization | Magek Framework</title><meta name="description" content="Documentation for Magek Framework"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><link rel="stylesheet" href="../assets/custom.css"/><script defer src="../assets/main.js"></script><script defer src="../assets/custom.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">Magek Framework</a><div id="tsd-toolbar-links"><a href="https://github.com/theam/magek">GitHub</a></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="Documentation.html">Documentation</a></li><li><a href="" aria-current="page">Authorization</a></li></ul></div><div class="tsd-panel tsd-typography"><h1 id="authorization" class="tsd-anchor-link">Authorization<a href="#authorization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Magek uses a whitelisting approach to authorize users to perform commands and read models. This means that you must explicitly specify which users are allowed to perform each action. In order to do that you must configure the <code>authorize</code> policy parameter on every Command or Read Model. This parameter accepts one of the following options:</p>
<ul>
<li><code>'all'</code>: The command or read-model is explicitly public, any user can access it.</li>
<li><code>[Role1, Role2, ...]</code>: An array of authorized <a href="#defining-roles">Roles</a>, this means that only those authenticated users that have any of the roles listed there are authorized to execute the command.</li>
<li>An authorizer function that matches the <code>CommandAuthorizer</code> interface for commands or the <code>ReadModelAuthorizer</code> interface for read models.</li>
</ul>
<h2 id="making-commands-and-read-models-public" class="tsd-anchor-link">Making commands and read models public<a href="#making-commands-and-read-models-public" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Setting the option <code>authorize: 'all'</code> in a command or read model will make it publicly accessible to anyone that has access to the GraphQL endpoint. For example, the following command can be executed by anyone, even if they don't provide a valid JWT token:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-2">&#39;all&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CreateComment</span><span class="hl-1"> {</span><br/><span class="hl-1">  ...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Danger:</strong> Think twice if you really need fully open GraphQL endpoints in your application, this might be useful during development, but we recommend to <strong>avoid exposing your endpoints in this way in production</strong>. Even for public APIs, it might be useful to issue API keys to avoid abuse. Magek is designed to scale to any given demand, but scaling also increases infrastructure costs! (See <a href="https://www.sciencedirect.com/science/article/pii/S221421262100079X">Denial of wallet attacks</a>)</p>
</blockquote>
<h2 id="simple-role-based-authorization" class="tsd-anchor-link">Simple Role-based authorization<a href="#simple-role-based-authorization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Magek provides a simple role-based authentication mechanism that will work in many standard scenarios. It is based on the concept of roles, which are just a set of permissions. For example, a <code>User</code> role might have the permission to <code>create</code> and <code>read</code> comments, while an <code>Admin</code> role might have the permission to <code>create</code>, <code>read</code>, and <code>delete</code> comments. You can define as many roles as you want, and then assign them to users.</p>
<h3 id="defining-roles" class="tsd-anchor-link">Defining @Roles<a href="#defining-roles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>As many other Magek artifacts, Magek Roles are defined as simple decorated classes. We recommend them to be defined in the <code>src/config/roles.ts</code> file, but it is not limited to that file. To define a role, you only need to decorate an empty class with the <code>@Role</code> decorator as follows:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Role</span><span class="hl-1">()</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">User</span><span class="hl-1"> {}</span><br/><br/><span class="hl-1">@</span><span class="hl-0">Role</span><span class="hl-1">()</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">Admin</span><span class="hl-1"> {}</span>
</code><button type="button">Copy</button></pre>

<h3 id="protecting-commands-and-read-models-with-roles" class="tsd-anchor-link">Protecting commands and read models with roles<a href="#protecting-commands-and-read-models-with-roles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Once you have defined your roles, you can use them to protect your commands and read models. For example, the following command can only be executed by users that have the role <code>Admin</code>:</p>
<pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> [</span><span class="hl-4">Admin</span><span class="hl-1">],</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CreateComment</span><span class="hl-1"> {</span><br/><span class="hl-1">  ...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This command will not be available to users with the role <code>User</code>.</p>
<h3 id="associating-users-with-roles" class="tsd-anchor-link">Associating users with roles<a href="#associating-users-with-roles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Magek will read the roles from the JWT token that you provide in the request. The token must include a claim with the key you specidied in the <code>rolesClaim</code> field. Magek will read such field and compare it with the declared ones in the <code>authorize</code> field of the protected command or read model.</p>
<p>For example, given the following setup:</p>
<h2 id="magek-config" class="tsd-anchor-link">Magek Config<a href="#magek-config" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="typescript"><br/><span class="hl-4">Magek</span><span class="hl-1">.</span><span class="hl-0">configure</span><span class="hl-1">(</span><span class="hl-2">&#39;production&#39;</span><span class="hl-1">, (</span><span class="hl-4">config</span><span class="hl-1">: </span><span class="hl-7">MagekConfig</span><span class="hl-1">): </span><span class="hl-7">void</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">config</span><span class="hl-1">.</span><span class="hl-4">appName</span><span class="hl-1"> = </span><span class="hl-2">&#39;my-store&#39;</span><br/><span class="hl-1">  </span><span class="hl-4">config</span><span class="hl-1">.</span><span class="hl-4">runtime</span><span class="hl-1"> = </span><span class="hl-4">ServerRuntime</span><br/><span class="hl-1">  </span><span class="hl-4">config</span><span class="hl-1">.</span><span class="hl-4">eventStoreAdapter</span><span class="hl-1"> = </span><span class="hl-4">eventStore</span><br/><span class="hl-1">  </span><span class="hl-4">config</span><span class="hl-1">.</span><span class="hl-4">tokenVerifiers</span><span class="hl-1"> = [</span><br/><span class="hl-1">    </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">JwksUriTokenVerifier</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-2">&#39;https://my-auth0-tenant.auth0.com/&#39;</span><span class="hl-1">, </span><span class="hl-5">// Issuer</span><br/><span class="hl-1">      </span><span class="hl-2">&#39;https://my-auth0-tenant.auth0.com/.well-known/jwks.json&#39;</span><span class="hl-1">, </span><span class="hl-5">// JWKS URL</span><br/><span class="hl-1">      </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">      </span><span class="hl-2">&#39;firebase:groups&#39;</span><span class="hl-1"> </span><span class="hl-5">// &lt;- roles are read from &#39;firebase:groups&#39; claim from the token</span><br/><span class="hl-1">    ),</span><br/><span class="hl-1">  ]</span><br/><span class="hl-1">})</span>
</code><button type="button">Copy</button></pre>

<h2 id="decoded-token" class="tsd-anchor-link">Decoded Token<a href="#decoded-token" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-5">// highlight-next-line</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;firebase:groups&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;User&quot;</span><span class="hl-1">, </span><span class="hl-5">// &lt;- roles are read from &#39;firebase:groups&#39; claim</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;iss&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;https://securetoken.google.com/demoapp&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;aud&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;demoapp&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;auth_time&quot;</span><span class="hl-1">: </span><span class="hl-9">1604676721</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;user_id&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;xJY5Y6fTbVggNtDjaNh7cNSBd7q1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;sub&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;xJY5Y6fTbVggNtDjaNh7cNSBd7q1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;iat&quot;</span><span class="hl-1">: </span><span class="hl-9">1604676721</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;exp&quot;</span><span class="hl-1">: </span><span class="hl-9">1604680321</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;phone_number&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;+999999999&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">&quot;firebase&quot;</span><span class="hl-1">: {}</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="magek-command" class="tsd-anchor-link">Magek Command<a href="#magek-command" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> [</span><span class="hl-4">Admin</span><span class="hl-1">],</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">CreateComment</span><span class="hl-1"> {</span><br/><span class="hl-1">  ...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="magek-roles" class="tsd-anchor-link">Magek Roles<a href="#magek-roles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="typescript"><span class="hl-1">@</span><span class="hl-0">Role</span><span class="hl-1">()</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">User</span><span class="hl-1"> {}</span><br/><br/><span class="hl-1">@</span><span class="hl-0">Role</span><span class="hl-1">()</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">Admin</span><span class="hl-1"> {}</span>
</code><button type="button">Copy</button></pre>

<p>Magek will check that the token contains the <code>firebase:groups</code> claim and that it contains the <code>Admin</code> role.
Also, if the token doesn't contain the <code>Admin</code> role, the command will not be executed. As you can see, the decoded token
has <code>User</code> as value of the <code>firebase:groups</code> claim, so the command will not be executed.</p>
<h2 id="custom-authorization-functions" class="tsd-anchor-link">Custom authorization functions<a href="#custom-authorization-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Magek also allows you to implement your own authorization functions, in case the role-based authorization model doesn't work for your application. In order to
apply your own authorization functions, you need to provide them in the <code>authorize</code> field of the command or read model. As authorization functions are regular
JavaScript functions, you can easily reuse them in your project or even in other Magek projects as a library.</p>
<h3 id="command-authorizers" class="tsd-anchor-link">Command Authorizers<a href="#command-authorizers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>As mentioned, the <code>authorize</code> parameter of the <code>@Command</code> can receive a function. However, this function must match the <code>CommandAuthorizer</code> type. This function will receive two parameters and return a <code>Promise</code> that will resolve if the user is authorized to execute the command or reject if not:</p>
<pre><code class="typescript"><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-7">CommandAuthorizer</span><span class="hl-1"> = (</span><span class="hl-4">currentUser</span><span class="hl-1">?: </span><span class="hl-7">UserEnvelope</span><span class="hl-1">, </span><span class="hl-4">input</span><span class="hl-1">?: </span><span class="hl-7">CommandInput</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>currentUser</td>
<td><code>UserEnvelope</code></td>
<td>User data decoded from the provided token</td>
</tr>
<tr>
<td>input</td>
<td><code>CommandInput</code></td>
<td>The input of the command</td>
</tr>
</tbody>
</table>
<p>For instance, if you want to restrict a command to users that have a permission named <code>Permission-To-Rock</code> in the <code>permissions</code> claim you can do this:</p>
<pre><code class="typescript"><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-0">CustomCommandAuthorizer</span><span class="hl-1">: </span><span class="hl-7">CommandAuthorizer</span><span class="hl-1"> = </span><span class="hl-3">async</span><span class="hl-1"> (</span><span class="hl-4">currentUser</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-4">currentUser</span><span class="hl-1">.</span><span class="hl-4">claims</span><span class="hl-1">[</span><span class="hl-2">&#39;permissions&#39;</span><span class="hl-1">].</span><span class="hl-0">includes</span><span class="hl-1">(</span><span class="hl-2">&#39;Permission-To-Rock&#39;</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`User </span><span class="hl-3">${</span><span class="hl-4">currentUser</span><span class="hl-11">.</span><span class="hl-4">username</span><span class="hl-3">}</span><span class="hl-2"> should not be rocking!`</span><span class="hl-1">) </span><span class="hl-5">// &lt;- This will reject the access to the command</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">@</span><span class="hl-0">Command</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-4">CustomCommandAuthorizer</span><span class="hl-1">,</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">PerformIncredibleGuitarSolo</span><span class="hl-1"> {</span><br/><span class="hl-1">  ...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="read-model-authorizers" class="tsd-anchor-link">Read Model Authorizers<a href="#read-model-authorizers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>As with commands, the <code>authorize</code> parameter of the <code>@ReadModel</code> decorator can also receive a function. However, this function must match the <code>ReadModelAuthorizer</code> type. This function will receive two parameters and return a <code>Promise</code> that will resolve if the user is authorized to execute the command or reject if not:</p>
<pre><code class="typescript"><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-7">ReadModelAuthorizer</span><span class="hl-1">&lt;</span><span class="hl-7">TReadModel</span><span class="hl-1"> </span><span class="hl-3">extends</span><span class="hl-1"> </span><span class="hl-7">ReadModelInterface</span><span class="hl-1">&gt; = (</span><br/><span class="hl-1">  </span><span class="hl-4">currentUser</span><span class="hl-1">?: </span><span class="hl-7">UserEnvelope</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">readModelRequestEnvelope</span><span class="hl-1">?: </span><span class="hl-7">ReadModelRequestEnvelope</span><span class="hl-1">&lt;</span><span class="hl-7">TReadModel</span><span class="hl-1">&gt;</span><br/><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>currentUser</td>
<td><code>UserEnvelope</code></td>
<td>User data decoded from the provided token</td>
</tr>
<tr>
<td>input</td>
<td><code>CommandInput</code></td>
<td>The input of the command</td>
</tr>
</tbody>
</table>
<p>For instance, you may want to restrict access to a specific resource only to people that has been granted read permission:</p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-0">CustomReadModelAuthorizer</span><span class="hl-1">: </span><span class="hl-7">ReadModelAuthorizer</span><span class="hl-1"> = </span><span class="hl-3">async</span><span class="hl-1"> (</span><span class="hl-4">currentUser</span><span class="hl-1">, </span><span class="hl-4">readModelRequestEnvelope</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">userPermissions</span><span class="hl-1"> = </span><span class="hl-4">Magek</span><span class="hl-1">.</span><span class="hl-0">entity</span><span class="hl-1">(</span><span class="hl-4">UserPermissions</span><span class="hl-1">, </span><span class="hl-4">currentUser</span><span class="hl-1">.</span><span class="hl-4">username</span><span class="hl-1">)</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-4">userPermissions</span><span class="hl-1"> || !</span><span class="hl-4">userPermissions</span><span class="hl-1">.</span><span class="hl-4">accessTo</span><span class="hl-1">[</span><span class="hl-4">readModelRequestEnvelope</span><span class="hl-1">.</span><span class="hl-4">className</span><span class="hl-1">].</span><span class="hl-0">includes</span><span class="hl-1">(</span><span class="hl-4">readModelRequestEnvelope</span><span class="hl-1">.</span><span class="hl-4">key</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`User </span><span class="hl-3">${</span><span class="hl-4">currentUser</span><span class="hl-11">.</span><span class="hl-4">username</span><span class="hl-3">}</span><span class="hl-2"> should not be looking here`</span><span class="hl-1">)</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">@</span><span class="hl-0">ReadModel</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorize:</span><span class="hl-1"> </span><span class="hl-4">CustomReadModelAuthorizer</span><br/><span class="hl-1">})</span>
</code><button type="button">Copy</button></pre>

<h3 id="event-stream-authorizers" class="tsd-anchor-link">Event Stream Authorizers<a href="#event-stream-authorizers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>You can restrict the access to the <a href="/features/event-stream">Event Stream</a> of an <code>Entity</code> by providing an <code>authorizeReadEvents</code> function in the <code>@Entity</code> decorator. This function is called every time an event stream is requested. The function must match the <code>EventStreamAuthorizer</code> type receives the current user and the event search request as parameters. The function must return a <code>Promise&lt;void&gt;</code>. If the promise is rejected, the request will be denied. If the promise is resolved successfully, the request will be allowed.</p>
<pre><code class="typescript"><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-7">EventStreamAuthorizer</span><span class="hl-1"> = (</span><br/><span class="hl-1">  </span><span class="hl-4">currentUser</span><span class="hl-1">?: </span><span class="hl-7">UserEnvelope</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">eventSearchRequest</span><span class="hl-1">?: </span><span class="hl-7">EventSearchRequest</span><br/><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-7">void</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p>For instance, you can restrict access to entities that the current user own.</p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-0">CustomEventAuthorizer</span><span class="hl-1">: </span><span class="hl-7">EventStreamAuthorizer</span><span class="hl-1"> = </span><span class="hl-3">async</span><span class="hl-1"> (</span><span class="hl-4">currentUser</span><span class="hl-1">, </span><span class="hl-4">eventSearchRequest</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> { </span><span class="hl-8">entityID</span><span class="hl-1"> } = </span><span class="hl-4">eventSearchRequest</span><span class="hl-1">.</span><span class="hl-4">parameters</span><br/><span class="hl-1">  </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-4">entityID</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-3">${</span><span class="hl-4">currentUser</span><span class="hl-11">.</span><span class="hl-4">username</span><span class="hl-3">}</span><span class="hl-2"> cannot list carts`</span><span class="hl-1">)</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-8">cart</span><span class="hl-1"> = </span><span class="hl-4">Magek</span><span class="hl-1">.</span><span class="hl-0">entity</span><span class="hl-1">(</span><span class="hl-4">Cart</span><span class="hl-1">, </span><span class="hl-4">entityID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-4">cart</span><span class="hl-1">.</span><span class="hl-4">ownerUserName</span><span class="hl-1"> !== </span><span class="hl-4">currentUser</span><span class="hl-1">.</span><span class="hl-4">userName</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-3">${</span><span class="hl-4">currentUser</span><span class="hl-11">.</span><span class="hl-4">username</span><span class="hl-3">}</span><span class="hl-2"> cannot see events in cart </span><span class="hl-3">${</span><span class="hl-4">entityID</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">)</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-1">@</span><span class="hl-0">Entity</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">authorizeReadEvents:</span><span class="hl-1"> </span><span class="hl-4">CustomEventAuthorizer</span><br/><span class="hl-1">})</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-7">Cart</span><span class="hl-1"> {</span><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">(</span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">UUID</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">id</span><span class="hl-1">!: </span><span class="hl-7">UUID</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">ownerUserName</span><span class="hl-1">!: </span><span class="hl-7">string</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-4">cartItems</span><span class="hl-1">!: </span><span class="hl-7">Array</span><span class="hl-1">&lt;</span><span class="hl-7">CartItem</span><span class="hl-1">&gt;</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">shippingAddress</span><span class="hl-1">?: </span><span class="hl-7">Address</span><br/><br/><span class="hl-1">  @</span><span class="hl-0">Field</span><span class="hl-1">()</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-4">checks</span><span class="hl-1">: </span><span class="hl-7">number</span><span class="hl-1"> = </span><span class="hl-9">0</span><br/><br/><span class="hl-1">  </span><span class="hl-5">// ... reducers</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#authorization"><span>Authorization</span></a><ul><li><a href="#making-commands-and-read-models-public"><span>Making commands and read models public</span></a></li><li><a href="#simple-role-based-authorization"><span>Simple <wbr/>Role-<wbr/>based authorization</span></a></li><li><ul><li><a href="#defining-roles"><span>Defining @<wbr/>Roles</span></a></li><li><a href="#protecting-commands-and-read-models-with-roles"><span>Protecting commands and read models with roles</span></a></li><li><a href="#associating-users-with-roles"><span>Associating users with roles</span></a></li></ul></li><li><a href="#magek-config"><span>Magek <wbr/>Config</span></a></li><li><a href="#decoded-token"><span>Decoded <wbr/>Token</span></a></li><li><a href="#magek-command"><span>Magek <wbr/>Command</span></a></li><li><a href="#magek-roles"><span>Magek <wbr/>Roles</span></a></li><li><a href="#custom-authorization-functions"><span>Custom authorization functions</span></a></li><li><ul><li><a href="#command-authorizers"><span>Command <wbr/>Authorizers</span></a></li><li><a href="#read-model-authorizers"><span>Read <wbr/>Model <wbr/>Authorizers</span></a></li><li><a href="#event-stream-authorizers"><span>Event <wbr/>Stream <wbr/>Authorizers</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/theam/magek" class="tsd-nav-link">GitHub</a></nav><nav class="tsd-navigation"><a href="../index.html">Magek Framework</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
