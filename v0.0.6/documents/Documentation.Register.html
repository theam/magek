<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Register | Magek Framework</title><meta name="description" content="Documentation for Magek Framework"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><link rel="stylesheet" href="../assets/custom.css"/><script defer src="../assets/main.js"></script><script defer src="../assets/custom.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">Magek Framework</a><div id="tsd-toolbar-links"><a href="https://github.com/theam/magek">GitHub</a><a href="https://magek.ai">Website</a></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="Documentation.html">Documentation</a></li><li><a href="" aria-current="page">Register</a></li></ul></div><div class="tsd-panel tsd-typography"><h1 id="advanced-uses-of-the-register-object" class="tsd-anchor-link">Advanced uses of the Register object<a href="#advanced-uses-of-the-register-object" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>The Register object is a built-in object that is automatically injected by the framework into all command or event handlers to let users interact with the execution context. It can be used for a variety of purposes, including:</p>
<ul>
<li>Registering events to be emitted at the end of the command or event handler</li>
<li>Manually flush the events to be persisted synchronously to the event store</li>
<li>Access the current signed in user, their roles and other claims included in their JWT token</li>
<li>In a command: Access the request context or alter the HTTP response headers</li>
</ul>
<h2 id="registering-events" class="tsd-anchor-link">Registering events<a href="#registering-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>When handling a command or event, you can use the Register object to register one or more events that will be emitted when the command or event handler is completed. Events are registered using the <code>register.events()</code> method, which takes one or more events as arguments. For example:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-4">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-3">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  </span><span class="hl-5">// Do some work...</span><br/><span class="hl-1">  register.events(new </span><span class="hl-0">OrderConfirmed</span><span class="hl-1">(this.orderID))</span><br/><span class="hl-1">  </span><span class="hl-5">// Do more work...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>In this example, we're registering an OrderConfirmed event to be persisted to the event store when the handler finishes. You can also register multiple events by passing them as separate arguments to the register.events() method:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-4">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-3">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  </span><span class="hl-5">// Do some work...</span><br/><span class="hl-1">  register.events(</span><br/><span class="hl-1">    new </span><span class="hl-0">OrderConfirmed</span><span class="hl-1">(this.orderID),</span><br/><span class="hl-1">    new </span><span class="hl-0">OrderShipped</span><span class="hl-1">(this.orderID)</span><br/><span class="hl-1">  )</span><br/><span class="hl-1">  </span><span class="hl-5">// Do more work...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>It's worth noting that events registered with <code>register.events()</code> aren't immediately persisted to the event store. Instead, they're stored in memory until the command or event handler finishes executing. To force the events to be persisted immediately, you can call the <code>register.flush()</code> method that is described in the next section.</p>
<h2 id="manually-flush-the-events" class="tsd-anchor-link">Manually flush the events<a href="#manually-flush-the-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>As mentioned in the previous section, events registered with <code>register.events()</code> aren't immediately persisted to the event store. Instead, they're stored in memory until the command or event handler finishes its execution, but this doesn't work in all situations, sometimes it's useful to store partial updates of a longer process, and some scenarios could accept partial successes. To force the events to be persisted and wait for the database to confirm the write, you can use the <code>register.flush()</code> method.</p>
<p>The <code>register.flush()</code> method takes no arguments and returns a promise that resolves when the events have been successfully persisted to the event store. For example:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-4">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-3">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  </span><span class="hl-5">// Do some work...</span><br/><span class="hl-1">  register.events(new </span><span class="hl-0">OrderConfirmed</span><span class="hl-1">(this.orderID))</span><br/><span class="hl-1">  await register.</span><span class="hl-0">flush</span><span class="hl-1">()</span><br/><span class="hl-1">  const mailID = await </span><span class="hl-0">sendConfirmationEmail</span><span class="hl-1">(this.orderID)</span><br/><span class="hl-1">  register.</span><span class="hl-0">events</span><span class="hl-1">(</span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-4">MailSent</span><span class="hl-1">(this.orderID, </span><span class="hl-4">mailID</span><span class="hl-1">))</span><br/><span class="hl-1">  </span><span class="hl-5">// Do more work...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>In this example, we're calling <code>register.flush()</code> after registering an <code>OrderConfirmed</code> event to ensure that it's persisted to the event store before continuing with the rest of the handler logic. In this way, even if an error happens while sending the confirmation email, the order will be persisted.</p>
<h2 id="access-the-current-signed-in-user" class="tsd-anchor-link">Access the current signed in user<a href="#access-the-current-signed-in-user" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>When handling a command or event, you can use the injected <code>Register</code> object to access the currently signed-in user as well as any metadata included in their JWT token like their roles or other claims (the specific claims will depend on the specific auth provider used). To do this, you can use the <code>currentUser</code> property. This property is an instance of the <code>UserEnvelope</code> class, which has the following properties:</p>
<pre><code class="typescript"><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">interface</span><span class="hl-1"> </span><span class="hl-7">UserEnvelope</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">id</span><span class="hl-1">?: </span><span class="hl-7">string</span><span class="hl-1"> </span><span class="hl-5">// An optional identifier of the user</span><br/><span class="hl-1">  </span><span class="hl-4">username</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1"> </span><span class="hl-5">// The unique username of the current user</span><br/><span class="hl-1">  </span><span class="hl-4">roles</span><span class="hl-1">: </span><span class="hl-7">Array</span><span class="hl-1">&lt;</span><span class="hl-7">string</span><span class="hl-1">&gt; </span><span class="hl-5">// The list of role names assigned to this user</span><br/><span class="hl-1">  </span><span class="hl-4">claims</span><span class="hl-1">: </span><span class="hl-7">Record</span><span class="hl-1">&lt;</span><span class="hl-7">string</span><span class="hl-1">, </span><span class="hl-7">unknown</span><span class="hl-1">&gt; </span><span class="hl-5">// An object containing the claims included in the body of the JWT token</span><br/><span class="hl-1">  </span><span class="hl-4">header</span><span class="hl-1">?: </span><span class="hl-7">Record</span><span class="hl-1">&lt;</span><span class="hl-7">string</span><span class="hl-1">, </span><span class="hl-7">unknown</span><span class="hl-1">&gt; </span><span class="hl-5">// An object containing the headers of the JWT token for further verification</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>For example, to access the username of the currently signed-in user, you can use the <code>currentUser.username</code> property:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-4">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-3">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  console.log(</span><span class="hl-2">`The currently signed-in user is </span><span class="hl-3">${</span><span class="hl-4">register</span><span class="hl-11">.</span><span class="hl-4">currentUser</span><span class="hl-11">?.</span><span class="hl-4">username</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-4">)</span><br/><span class="hl-4">}</span><br/><br/><span class="hl-5">// Output: The currently signed-in user is john.doe</span>
</code><button type="button">Copy</button></pre>

<h2 id="command-specific-features" class="tsd-anchor-link">Command-specific features<a href="#command-specific-features" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The command handlers are executed as part of a GraphQL mutation request, so they have access to a few additional features that are specific to commands that can be used to access the request context or alter the HTTP response headers.</p>
<h3 id="access-the-request-context" class="tsd-anchor-link">Access the request context<a href="#access-the-request-context" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The request context is injected in the command handler as part of the register command and you can access it using the <code>context</code> property. This property is an instance of the <code>ContextEnvelope</code> interface, which has the following properties:</p>
<pre><code class="typescript"><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-3">interface</span><span class="hl-1"> </span><span class="hl-7">ContextEnvelope</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">/** Decoded request header and body */</span><br/><span class="hl-1">  </span><span class="hl-4">request</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-4">headers</span><span class="hl-1">: </span><span class="hl-7">unknown</span><br/><span class="hl-1">    </span><span class="hl-4">body</span><span class="hl-1">: </span><span class="hl-7">unknown</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-5">/** Runtime-dependent raw request context object */</span><br/><span class="hl-1">  </span><span class="hl-4">rawContext</span><span class="hl-1">: </span><span class="hl-7">unknown</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The <code>request</code> property exposes a normalized version of the request headers and body that can be used regardless the provider. We recommend using this property instead of the <code>rawContext</code> property, as it will be more portable across providers.</p>
<p>The <code>rawContext</code> property exposes the full raw request context as it comes in the original request.</p>
<h3 id="alter-the-http-response-headers" class="tsd-anchor-link">Alter the HTTP response headers<a href="#alter-the-http-response-headers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Finally, you can use the <code>responseHeaders</code> property to alter the HTTP response headers that will be sent back to the client. This property is a plain Typescript object which is initialized with the default headers. You can add, remove or modify any of the headers by using the standard object methods:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">handle</span><span class="hl-1">(</span><span class="hl-4">register</span><span class="hl-1">: </span><span class="hl-4">Register</span><span class="hl-1">): </span><span class="hl-7">Promise</span><span class="hl-1">&lt;</span><span class="hl-3">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  register.responseHeaders</span><span class="hl-4">[</span><span class="hl-2">&#39;X-My-Header&#39;</span><span class="hl-4">] = &#39;My custom header&#39;</span><br/><span class="hl-4">  register.responseHeaders[</span><span class="hl-2">&#39;X-My-Other-Header&#39;</span><span class="hl-4">] = &#39;My other custom header&#39;</span><br/><span class="hl-4">  delete register.responseHeaders[</span><span class="hl-2">&#39;X-My-Other-Header&#39;</span><span class="hl-4">]</span><br/><span class="hl-4">}</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#advanced-uses-of-the-register-object"><span>Advanced uses of the <wbr/>Register object</span></a><ul><li><a href="#registering-events"><span>Registering events</span></a></li><li><a href="#manually-flush-the-events"><span>Manually flush the events</span></a></li><li><a href="#access-the-current-signed-in-user"><span>Access the current signed in user</span></a></li><li><a href="#command-specific-features"><span>Command-<wbr/>specific features</span></a></li><li><ul><li><a href="#access-the-request-context"><span>Access the request context</span></a></li><li><a href="#alter-the-http-response-headers"><span>Alter the <wbr/>HTTP response headers</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/theam/magek" class="tsd-nav-link">GitHub</a><a href="https://magek.ai" class="tsd-nav-link">Website</a></nav><nav class="tsd-navigation"><a href="../index.html">Magek Framework</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
